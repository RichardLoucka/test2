import{A as ie,B as je,C as Ve,D as Ge,E as Ze,G as _e,H as Ue,a as Re,b as _,c as fe,d as We,e as Le,f as G,g as H,h,j as ze,k as He,l as Fe,m as Ie,n as F,o as I,p as U,q as $e,r as $,s as x,t as me,u as B,v as N,w as re,x as D,y as ne,z as he}from"./lib.SM2D2BUH.js";var er=e=>he(e.orig.pos[0],e.dest.pos[0])<=1&&(he(e.orig.pos[0],e.dest.pos[0])===1?e.dest.pos[1]===e.orig.pos[1]+(e.color==="white"?1:-1):_e(...e.orig.pos,...e.dest.pos,e.color==="white")),or=e=>ie(...e.orig.pos,...e.dest.pos),Qe=e=>Ve(...e.orig.pos,...e.dest.pos),Ye=e=>je(...e.orig.pos,...e.dest.pos),rr=e=>Qe(e)||Ye(e),nr=e=>Ze(...e.orig.pos,...e.dest.pos)||e.orig.pos[1]===e.dest.pos[1]&&e.orig.pos[1]===(e.color==="white"?0:7)&&(e.orig.pos[0]===4&&(e.dest.pos[0]===2&&e.rookFilesFriendlies.includes(0)||e.dest.pos[0]===6&&e.rookFilesFriendlies.includes(7))||e.rookFilesFriendlies.includes(e.dest.pos[0])),ir={pawn:er,knight:or,bishop:Qe,rook:Ye,queen:rr,king:nr};function ge(e,o){let r=e.pieces,n=r.get(o);if(!n||n.color===e.turnColor)return[];let i=n.color,t=new Map([...r].filter(([c,a])=>a.color===i)),s=new Map([...r].filter(([c,a])=>a.color===F(i))),p={key:o,pos:h(o)},d=c=>ir[n.role](c)&&e.premovable.additionalPremoveRequirements(c),l={orig:p,role:n.role,allPieces:r,friendlies:t,enemies:s,color:i,rookFilesFriendlies:Array.from(r).filter(([c,a])=>c[1]===(i==="white"?"1":"8")&&a.color===i&&a.role==="rook").map(([c])=>h(c)[0]),lastMove:e.lastMove};return He.filter(c=>d({...l,dest:c})).map(c=>c.key)}function C(e,...o){e&&setTimeout(()=>e(...o),1)}function Xe(e){e.orientation=F(e.orientation),e.animation.current=e.draggable.current=e.selected=void 0}function Je(e,o){for(let[r,n]of o)n?e.pieces.set(r,n):e.pieces.delete(r)}function eo(e,o){if(e.check=void 0,o===!0&&(o=e.turnColor),o)for(let[r,n]of e.pieces)n.role==="king"&&n.color===o&&(e.check=r)}function tr(e,o,r,n){E(e),e.premovable.current=[o,r],C(e.premovable.events.set,o,r,n)}function q(e){e.premovable.current&&(e.premovable.current=void 0,C(e.premovable.events.unset))}function lr(e,o,r){q(e),e.predroppable.current={role:o,key:r},C(e.predroppable.events.set,o,r)}function E(e){let o=e.predroppable;o.current&&(o.current=void 0,C(o.events.unset))}function sr(e,o,r){if(!e.autoCastle)return!1;let n=e.pieces.get(o);if(!n||n.role!=="king")return!1;let i=h(o),t=h(r);if(i[1]!==0&&i[1]!==7||i[1]!==t[1])return!1;i[0]===4&&!e.pieces.has(r)&&(t[0]===6?r=H([7,t[1]]):t[0]===2&&(r=H([0,t[1]])));let s=e.pieces.get(r);return!s||s.color!==n.color||s.role!=="rook"?!1:(e.pieces.delete(o),e.pieces.delete(r),i[0]<t[0]?(e.pieces.set(H([6,t[1]]),n),e.pieces.set(H([5,t[1]]),s)):(e.pieces.set(H([2,t[1]]),n),e.pieces.set(H([3,t[1]]),s)),!0)}function be(e,o,r){let n=e.pieces.get(o),i=e.pieces.get(r);if(o===r||!n)return!1;let t=i&&i.color!==n.color?i:void 0;return r===e.selected&&k(e),C(e.events.move,o,r,t),sr(e,o,r)||(e.pieces.set(r,n),e.pieces.delete(o)),e.lastMove=[o,r],e.check=void 0,C(e.events.change),t||!0}function te(e,o,r,n){if(e.pieces.has(r))if(n)e.pieces.delete(r);else return!1;return C(e.events.dropNewPiece,o,r),e.pieces.set(r,o),e.lastMove=[r],e.check=void 0,C(e.events.change),e.movable.dests=void 0,e.turnColor=F(e.turnColor),!0}function oo(e,o,r){let n=be(e,o,r);return n&&(e.movable.dests=void 0,e.turnColor=F(e.turnColor),e.animation.current=void 0),n}function ve(e,o,r){if(se(e,o,r)){let n=oo(e,o,r);if(n){let i=e.hold.stop();k(e);let t={premove:!1,ctrlKey:e.stats.ctrlKey,holdTime:i};return n!==!0&&(t.captured=n),C(e.movable.events.after,o,r,t),!0}}else if(ar(e,o,r))return tr(e,o,r,{ctrlKey:e.stats.ctrlKey}),k(e),!0;return k(e),!1}function le(e,o,r,n){let i=e.pieces.get(o);i&&(cr(e,o,r)||n)?(e.pieces.delete(o),te(e,i,r,n),C(e.movable.events.afterNewPiece,i.role,r,{premove:!1,predrop:!1})):i&&dr(e,o,r)?lr(e,i.role,r):(q(e),E(e)),e.pieces.delete(o),k(e)}function Y(e,o,r){if(C(e.events.select,o),e.selected){if(e.selected===o&&!e.draggable.enabled){k(e),e.hold.cancel();return}else if((e.selectable.enabled||r)&&e.selected!==o&&ve(e,e.selected,o)){e.stats.dragged=!1;return}}(e.selectable.enabled||e.draggable.enabled)&&(ro(e,o)||ye(e,o))&&(we(e,o),e.hold.start())}function we(e,o){e.selected=o,ye(e,o)?e.premovable.customDests||(e.premovable.dests=ge(e,o)):e.premovable.dests=void 0}function k(e){e.selected=void 0,e.premovable.dests=void 0,e.hold.cancel()}function ro(e,o){let r=e.pieces.get(o);return!!r&&(e.movable.color==="both"||e.movable.color===r.color&&e.turnColor===r.color)}var se=(e,o,r)=>{var n,i;return o!==r&&ro(e,o)&&(e.movable.free||!!((i=(n=e.movable.dests)==null?void 0:n.get(o))!=null&&i.includes(r)))};function cr(e,o,r){let n=e.pieces.get(o);return!!n&&(o===r||!e.pieces.has(r))&&(e.movable.color==="both"||e.movable.color===n.color&&e.turnColor===n.color)}function ye(e,o){let r=e.pieces.get(o);return!!r&&e.premovable.enabled&&e.movable.color===r.color&&e.turnColor!==r.color}var ar=(e,o,r)=>{var n,i;return o!==r&&ye(e,o)&&((i=(n=e.premovable.customDests)==null?void 0:n.get(o))!=null?i:ge(e,o)).includes(r)};function dr(e,o,r){let n=e.pieces.get(o),i=e.pieces.get(r);return!!n&&(!i||i.color!==e.movable.color)&&e.predroppable.enabled&&(n.role!=="pawn"||r[1]!=="1"&&r[1]!=="8")&&e.movable.color===n.color&&e.turnColor!==n.color}function no(e,o){let r=e.pieces.get(o);return!!r&&e.draggable.enabled&&(e.movable.color==="both"||e.movable.color===r.color&&(e.turnColor===r.color||e.premovable.enabled))}function io(e){let o=e.premovable.current;if(!o)return!1;let r=o[0],n=o[1],i=!1;if(se(e,r,n)){let t=oo(e,r,n);if(t){let s={premove:!0};t!==!0&&(s.captured=t),C(e.movable.events.after,r,n,s),i=!0}}return q(e),i}function to(e,o){let r=e.predroppable.current,n=!1;if(!r)return!1;if(o(r)){let i={role:r.role,color:e.movable.color};te(e,i,r.key)&&(C(e.movable.events.afterNewPiece,r.role,r.key,{premove:!1,predrop:!0}),n=!0)}return E(e),n}function X(e){q(e),E(e),k(e)}function Pe(e){e.movable.color=e.movable.dests=e.animation.current=void 0,X(e)}function K(e,o,r){let n=Math.floor(8*(e[0]-r.left)/r.width);o||(n=7-n);let i=7-Math.floor(8*(e[1]-r.top)/r.height);return o||(i=7-i),n>=0&&n<8&&i>=0&&i<8?G([n,i]):void 0}function lo(e,o,r,n){let i=h(e),t=ze.filter(l=>$e(i,l)||Ge(i[0],i[1],l[0],l[1])||ie(i[0],i[1],l[0],l[1])),p=t.map(l=>ne(H(l),r,n)).map(l=>I(o,l)),[,d]=p.reduce((l,c,a)=>l[0]<c?l:[c,a],[p[0],0]);return G(t[d])}var v=e=>e.orientation==="white";var pr=["green","red","blue","yellow"];function so(e,o){if(o.touches&&o.touches.length>1)return;o.stopPropagation(),o.preventDefault(),o.ctrlKey?k(e):X(e);let r=N(o),n=K(r,v(e),e.dom.bounds());n&&(e.drawable.current={orig:n,pos:r,brush:ur(o),snapToValidMove:e.drawable.defaultSnapToValidMove},co(e))}function co(e){requestAnimationFrame(()=>{let o=e.drawable.current;if(o){let r=K(o.pos,v(e),e.dom.bounds());r||(o.snapToValidMove=!1);let n=o.snapToValidMove?lo(o.orig,o.pos,v(e),e.dom.bounds()):r;n!==o.mouseSq&&(o.mouseSq=n,o.dest=n!==o.orig?n:void 0,e.dom.redrawNow()),co(e)}})}function ao(e,o){e.drawable.current&&(e.drawable.current.pos=N(o))}function po(e){let o=e.drawable.current;o&&(o.mouseSq&&fr(e.drawable,o),Ce(e))}function Ce(e){e.drawable.current&&(e.drawable.current=void 0,e.dom.redraw())}function uo(e){e.drawable.shapes.length&&(e.drawable.shapes=[],e.dom.redraw(),fo(e.drawable))}var ce=(e,o)=>e.orig===o.orig&&e.dest===o.dest,Me=(e,o)=>e.brush===o.brush;function ur(e){var n;let o=(e.shiftKey||e.ctrlKey)&&re(e),r=e.altKey||e.metaKey||((n=e.getModifierState)==null?void 0:n.call(e,"AltGraph"));return pr[(o?1:0)+(r?2:0)]}function fr(e,o){let r=e.shapes.find(n=>ce(n,o));r&&(e.shapes=e.shapes.filter(n=>!ce(n,o))),(!r||!Me(r,o))&&e.shapes.push({orig:o.orig,dest:o.dest,brush:o.brush}),fo(e)}function fo(e){e.onChange&&e.onChange(e.shapes)}var R=(e,o)=>o.animation.enabled?br(e,o):W(e,o);function W(e,o){let r=e(o);return o.dom.redraw(),r}var Se=(e,o)=>({key:e,pos:h(e),piece:o}),hr=(e,o)=>o.sort((r,n)=>I(e.pos,r.pos)-I(e.pos,n.pos))[0];function gr(e,o){let r=new Map,n=[],i=new Map,t=[],s=[],p=new Map,d,l,c;for(let[a,f]of e)p.set(a,Se(a,f));for(let a of Le)d=o.pieces.get(a),l=p.get(a),d?l?U(d,l.piece)||(t.push(l),s.push(Se(a,d))):s.push(Se(a,d)):l&&t.push(l);for(let a of s)l=hr(a,t.filter(f=>U(a.piece,f.piece))),l&&(c=[l.pos[0]-a.pos[0],l.pos[1]-a.pos[1]],r.set(a.key,c.concat(c)),n.push(l.key));for(let a of t)n.includes(a.key)||i.set(a.key,a.piece);return{anims:r,fadings:i}}function mo(e,o){let r=e.animation.current;if(r===void 0){e.dom.destroyed||e.dom.redrawNow();return}let n=1-(o-r.start)*r.frequency;if(n<=0)e.animation.current=void 0,e.dom.redrawNow();else{let i=vr(n);for(let t of r.plan.anims.values())t[2]=t[0]*i,t[3]=t[1]*i;e.dom.redrawNow(!0),requestAnimationFrame((t=performance.now())=>mo(e,t))}}function br(e,o){let r=new Map(o.pieces),n=e(o),i=gr(r,o);if(i.anims.size||i.fadings.size){let t=o.animation.current&&o.animation.current.start;o.animation.current={start:performance.now(),frequency:1/o.animation.duration,plan:i},t||mo(o,performance.now())}else o.dom.redraw();return n}var vr=e=>e<.5?4*e*e*e:(e-1)*(2*e-2)*(2*e-2)+1;function ho(e,o){if(!(e.trustAllEvents||o.isTrusted)||o.buttons!==void 0&&o.buttons>1||o.touches&&o.touches.length>1)return;let r=e.dom.bounds(),n=N(o),i=K(n,v(e),r);if(!i)return;let t=e.pieces.get(i),s=e.selected;if(!s&&e.drawable.enabled&&(e.drawable.eraseOnMovablePieceClick||!t||t.color!==e.turnColor)&&uo(e),o.cancelable!==!1&&(!o.touches||e.blockTouchScroll||t||s||wr(e,n)))o.preventDefault();else if(o.touches)return;let p=!!e.premovable.current,d=!!e.predroppable.current;e.stats.ctrlKey=o.ctrlKey,e.selected&&se(e,e.selected,i)?R(a=>Y(a,i),e):Y(e,i);let l=e.selected===i,c=yo(e,i);if(t&&c&&l&&no(e,i)){e.draggable.current={orig:i,piece:t,origPos:n,pos:n,started:e.draggable.autoDistance&&e.stats.dragged,element:c,previouslySelected:s,originTarget:o.target,keyHasChanged:!1},c.cgDragging=!0,c.classList.add("dragging");let a=e.dom.elements.ghost;a&&(a.className=`ghost ${t.color} ${t.role}`,x(a,$(r)(h(i),v(e))),B(a,!0)),xe(e)}else p&&q(e),d&&E(e);e.dom.redraw()}function wr(e,o){let r=v(e),n=e.dom.bounds(),i=Math.pow(e.touchIgnoreRadius*n.width/16,2)*2;for(let t of e.pieces.keys()){let s=ne(t,r,n);if(I(s,o)<=i)return!0}return!1}function go(e,o,r,n){e.pieces.set("a0",o),e.dom.redraw();let t=N(r);e.draggable.current={orig:"a0",piece:o,origPos:t,pos:t,started:!0,element:()=>yo(e,"a0"),originTarget:r.target,newPiece:!0,force:!!n,keyHasChanged:!1},xe(e)}function xe(e){requestAnimationFrame(()=>{var n;let o=e.draggable.current;if(!o)return;(n=e.animation.current)!=null&&n.plan.anims.has(o.orig)&&(e.animation.current=void 0);let r=e.pieces.get(o.orig);if(!r||!U(r,o.piece))j(e);else if(!o.started&&I(o.pos,o.origPos)>=Math.pow(e.draggable.distance,2)&&(o.started=!0),o.started){if(typeof o.element=="function"){let t=o.element();if(!t)return;t.cgDragging=!0,t.classList.add("dragging"),o.element=t}let i=e.dom.bounds();x(o.element,[o.pos[0]-i.left-i.width/16,o.pos[1]-i.top-i.height/16]),o.keyHasChanged||(o.keyHasChanged=o.orig!==K(o.pos,v(e),i))}xe(e)})}function bo(e,o){e.draggable.current&&(!o.touches||o.touches.length<2)&&(e.draggable.current.pos=N(o))}function vo(e,o){let r=e.draggable.current;if(!r)return;if(o.type==="touchend"&&o.cancelable!==!1&&o.preventDefault(),o.type==="touchend"&&r.originTarget!==o.target&&!r.newPiece){e.draggable.current=void 0;return}q(e),E(e);let n=N(o)||r.pos,i=K(n,v(e),e.dom.bounds());i&&r.started&&r.orig!==i?r.newPiece?le(e,r.orig,i,r.force):(e.stats.ctrlKey=o.ctrlKey,ve(e,r.orig,i)&&(e.stats.dragged=!0)):r.newPiece?e.pieces.delete(r.orig):e.draggable.deleteOnDropOff&&!i&&(e.pieces.delete(r.orig),C(e.events.change)),(r.orig===r.previouslySelected||r.keyHasChanged)&&(r.orig===i||!i)?k(e):e.selectable.enabled||k(e),wo(e),e.draggable.current=void 0,e.dom.redraw()}function j(e){let o=e.draggable.current;o&&(o.newPiece&&e.pieces.delete(o.orig),e.draggable.current=void 0,k(e),wo(e),e.dom.redraw())}function wo(e){let o=e.dom.elements;o.ghost&&B(o.ghost,!1)}function yo(e,o){let r=e.dom.elements.board.firstChild;for(;r;){if(r.cgKey===o&&r.tagName==="PIECE")return r;r=r.nextSibling}}var De="rnbqkbnr/pppppppp/8/8/8/8/PPPPPPPP/RNBQKBNR",Pr={p:"pawn",r:"rook",n:"knight",b:"bishop",q:"queen",k:"king"},kr={pawn:"p",rook:"r",knight:"n",bishop:"b",queen:"q",king:"k"};function ae(e){e==="start"&&(e=De);let o=new Map,r=7,n=0;for(let i of e)switch(i){case" ":case"[":return o;case"/":if(--r,r<0)return o;n=0;break;case"~":{let t=G([n-1,r]),s=t&&o.get(t);s&&(s.promoted=!0);break}default:{let t=i.charCodeAt(0);if(t<57)n+=t-48;else{let s=i.toLowerCase(),p=G([n,r]);p&&o.set(p,{role:Pr[s],color:i===s?"black":"white"}),++n}}}return o}function Po(e){return We.map(o=>_.map(r=>{let n=e.get(r+o);if(n){let i=kr[n.role];return n.color==="white"&&(i=i.toUpperCase()),n.promoted&&(i+="~"),i}else return"1"}).join("")).join("/").replace(/1{2,}/g,o=>o.length.toString())}function Ae(e,o){o.animation&&(qe(e.animation,o.animation),(e.animation.duration||0)<70&&(e.animation.enabled=!1))}function de(e,o){var r,n,i;if((r=o.movable)!=null&&r.dests&&(e.movable.dests=void 0),(n=o.drawable)!=null&&n.autoShapes&&(e.drawable.autoShapes=[]),qe(e,o),o.fen&&(e.pieces=ae(o.fen),e.drawable.shapes=((i=o.drawable)==null?void 0:i.shapes)||[]),"check"in o&&eo(e,o.check||!1),"lastMove"in o&&!o.lastMove?e.lastMove=void 0:o.lastMove&&(e.lastMove=o.lastMove),e.selected&&we(e,e.selected),Ae(e,o),!e.movable.rookCastle&&e.movable.dests){let t=e.movable.color==="white"?"1":"8",s="e"+t,p=e.movable.dests.get(s),d=e.pieces.get(s);if(!p||!d||d.role!=="king")return;e.movable.dests.set(s,p.filter(l=>!(l==="a"+t&&p.includes("c"+t))&&!(l==="h"+t&&p.includes("g"+t))))}}function qe(e,o){for(let r in o)r==="__proto__"||r==="constructor"||!Object.prototype.hasOwnProperty.call(o,r)||(Object.prototype.hasOwnProperty.call(e,r)&&ko(e[r])&&ko(o[r])?qe(e[r],o[r]):e[r]=o[r])}function ko(e){if(typeof e!="object"||e===null)return!1;let o=Object.getPrototypeOf(e);return o===Object.prototype||o===null}function Mo(e,o){e.exploding={stage:1,keys:o},e.dom.redraw(),setTimeout(()=>{Co(e,2),setTimeout(()=>Co(e,void 0),120)},120)}function Co(e,o){e.exploding&&(o?e.exploding.stage=o:e.exploding=void 0,e.dom.redraw())}function So(e,o){function r(){Xe(e),o()}return{set(n){n.orientation&&n.orientation!==e.orientation&&r(),Ae(e,n),(n.fen?R:W)(i=>de(i,n),e)},state:e,getFen:()=>Po(e.pieces),toggleOrientation:r,setPieces(n){R(i=>Je(i,n),e)},selectSquare(n,i){n?R(t=>Y(t,n,i),e):e.selected&&(k(e),e.dom.redraw())},move(n,i){R(t=>be(t,n,i),e)},newPiece(n,i){R(t=>te(t,n,i),e)},playPremove(){if(e.premovable.current){if(R(io,e))return!0;e.dom.redraw()}return!1},playPredrop(n){if(e.predroppable.current){let i=to(e,n);return e.dom.redraw(),i}return!1},cancelPremove(){W(q,e)},cancelPredrop(){W(E,e)},cancelMove(){W(n=>{X(n),j(n)},e)},stop(){W(n=>{Pe(n),j(n)},e)},explode(n){Mo(e,n)},setAutoShapes(n){W(i=>i.drawable.autoShapes=n,e)},setShapes(n){W(i=>i.drawable.shapes=n.slice(),e)},getKeyAtDomPos(n){return K(n,v(e),e.dom.bounds())},redrawAll:o,dragNewPiece(n,i,t){go(e,n,i,t)},destroy(){Pe(e),e.dom.unbind&&e.dom.unbind(),e.dom.destroyed=!0}}}function xo(){return{pieces:ae(De),orientation:"white",turnColor:"white",coordinates:!0,coordinatesOnSquares:!1,ranksPosition:"right",autoCastle:!0,viewOnly:!1,disableContextMenu:!1,addPieceZIndex:!1,blockTouchScroll:!1,touchIgnoreRadius:1,pieceKey:!1,trustAllEvents:!1,highlight:{lastMove:!0,check:!0},animation:{enabled:!0,duration:200},movable:{free:!0,color:"both",showDests:!0,events:{},rookCastle:!0},premovable:{enabled:!0,showDests:!0,castle:!0,additionalPremoveRequirements:e=>!0,events:{}},predroppable:{enabled:!1,events:{}},draggable:{enabled:!0,distance:3,autoDistance:!0,showGhost:!0,deleteOnDropOff:!1},dropmode:{active:!1},selectable:{enabled:!0},stats:{dragged:!("ontouchstart"in window)},events:{},drawable:{enabled:!0,visible:!0,defaultSnapToValidMove:!0,eraseOnMovablePieceClick:!0,shapes:[],autoShapes:[],brushes:{green:{key:"g",color:"#15781B",opacity:1,lineWidth:10},red:{key:"r",color:"#882020",opacity:1,lineWidth:10},blue:{key:"b",color:"#003088",opacity:1,lineWidth:10},yellow:{key:"y",color:"#e68f00",opacity:1,lineWidth:10},paleBlue:{key:"pb",color:"#003088",opacity:.4,lineWidth:15},paleGreen:{key:"pg",color:"#15781B",opacity:.4,lineWidth:15},paleRed:{key:"pr",color:"#882020",opacity:.4,lineWidth:15},paleGrey:{key:"pgr",color:"#4a4a4a",opacity:.35,lineWidth:15},purple:{key:"purple",color:"#68217a",opacity:.65,lineWidth:10},pink:{key:"pink",color:"#ee2080",opacity:.5,lineWidth:10},white:{key:"white",color:"white",opacity:1,lineWidth:10},paleWhite:{key:"pwhite",color:"white",opacity:.6,lineWidth:10}},prevSvgHash:""},hold:Ie()}}function Eo(){let e=w("defs"),o=y(w("filter"),{id:"cg-filter-blur"});return o.appendChild(y(w("feGaussianBlur"),{stdDeviation:"0.013"})),e.appendChild(o),e}function Ko(e,o){var a;let r=e.drawable,n=r.current,i=n&&n.mouseSq?n:void 0,t=new Map,s=e.dom.bounds(),p=r.autoShapes.filter(f=>!f.piece);for(let f of r.shapes.concat(p).concat(i?[i]:[])){if(!f.dest)continue;let m=(a=t.get(f.dest))!=null?a:new Set,u=ue(pe(h(f.orig),e.orientation),s),g=ue(pe(h(f.dest),e.orientation),s);m.add(Lo(zo(u,g))),t.set(f.dest,m)}let d=[],l=i?r.shapes.findIndex(f=>ce(f,i)&&Me(f,i)):-1;for(let[f,m]of r.shapes.concat(p).entries()){let u=l!==-1&&l===f;d.push({shape:m,current:!1,pendingErase:u,hash:Do(m,Ee(m.dest,t),!1,s,u,qo(m.dest,t))})}i&&l===-1&&d.push({shape:i,current:!0,hash:Do(i,Ee(i.dest,t),!0,s,!1,qo(i.dest,t)),pendingErase:!1});let c=d.map(f=>f.hash).join(";");c!==e.drawable.prevSvgHash&&(e.drawable.prevSvgHash=c,Mr(r,d,o),Sr(d,o,f=>Ar(e,f,r.brushes,t,s)))}function Mr(e,o,r){for(let n of[r.shapes,r.shapesBelow]){let i=n.querySelector("defs"),t=o.filter(l=>n===r.shapesBelow==!!l.shape.below),s=new Map;for(let l of t.filter(c=>c.shape.dest&&c.shape.brush)){let c=Bo(e.brushes[l.shape.brush],l.shape.modifiers),{key:a,color:f}=Ro(l.shape);a&&f&&s.set(a,{key:a,color:f,opacity:1,lineWidth:1}),s.set(c.key,c)}let p=new Set,d=i.firstElementChild;for(;d;)p.add(d.getAttribute("cgKey")),d=d.nextElementSibling;for(let[l,c]of s.entries())p.has(l)||i.appendChild(Kr(c))}}function Sr(e,o,r){for(let[n,i]of[[o.shapes,o.custom],[o.shapesBelow,o.customBelow]]){let[t,s]=[n,i].map(l=>l.querySelector("g")),p=e.filter(l=>n===o.shapesBelow==!!l.shape.below),d=new Map;for(let l of p)d.set(l.hash,!1);for(let l of[t,s]){let c=[],a=l.firstElementChild,f;for(;a;)f=a.getAttribute("cgHash"),d.has(f)?d.set(f,!0):c.push(a),a=a.nextElementSibling;for(let m of c)l.removeChild(m)}for(let l of p.filter(c=>!d.get(c.hash)))for(let c of r(l))c.isCustom?s.appendChild(c.el):t.appendChild(c.el)}}function Do({orig:e,dest:o,brush:r,piece:n,modifiers:i,customSvg:t,label:s,below:p},d,l,c,a,f){var m,u;return[c.width,c.height,l,a&&"pendingErase",f,e,o,r,d&&"-",n&&xr(n),i&&Dr(i),t&&`custom-${Ao(t.html)},${(u=(m=t.center)==null?void 0:m[0])!=null?u:"o"}`,s&&`label-${Ao(s.text)}`,p&&"below"].filter(g=>g).join(",")}var xr=e=>[e.color,e.role,e.scale].filter(o=>o).join(","),Dr=e=>[e.lineWidth,e.hilite].filter(o=>o).join(",");function Ao(e){let o=0;for(let r=0;r<e.length;r++)o=(o<<5)-o+e.charCodeAt(r)>>>0;return o.toString()}function Ar(e,{shape:o,current:r,pendingErase:n,hash:i},t,s,p){var m,u;let d=ue(pe(h(o.orig),e.orientation),p),l=o.dest?ue(pe(h(o.dest),e.orientation),p):d,c=o.brush&&Bo(t[o.brush],o.modifiers),a=s.get(o.dest),f=[];if(c){let g=y(w("g"),{cgHash:i});f.push({el:g}),d[0]!==l[0]||d[1]!==l[1]?g.appendChild(Er(o,c,d,l,r,Ee(o.dest,s),n)):g.appendChild(qr(t[o.brush],d,r,p,n))}if(o.label){let g=o.label;(m=g.fill)!=null||(g.fill=o.brush&&t[o.brush].color);let M=o.brush?void 0:"tr";f.push({el:Tr(g,i,d,l,a,M),isCustom:!0})}if(o.customSvg){let g=(u=o.customSvg.center)!=null?u:"orig",[M,P]=g==="label"?Ho(d,l,a).map(z=>z-.5):g==="dest"?l:d,A=y(w("g"),{transform:`translate(${M},${P})`,cgHash:i});A.innerHTML=`<svg width="1" height="1" viewBox="0 0 100 100">${o.customSvg.html}</svg>`,f.push({el:A,isCustom:!0})}return f}function qr(e,o,r,n,i){let t=Or(),s=(n.width+n.height)/(4*Math.max(n.width,n.height));return y(w("circle"),{stroke:e.color,"stroke-width":t[r?0:1],fill:"none",opacity:Wo(e,r,i),cx:o[0],cy:o[1],r:s-t[1]/2})}function Er(e,o,r,n,i,t,s){var c;function p(a){var z;let f=Br(t&&!i),m=n[0]-r[0],u=n[1]-r[1],g=Math.atan2(u,m),M=Math.cos(g)*f,P=Math.sin(g)*f,A=Ro(e);return y(w("line"),{stroke:a?A.color:o.color,"stroke-width":Nr(o,i)*(a?1.14:1),"stroke-linecap":"round","marker-end":`url(#arrowhead-${a?A.key:o.key})`,opacity:(z=e.modifiers)!=null&&z.hilite&&!s?1:Wo(o,i,s),x1:r[0],y1:r[1],x2:n[0]-M,y2:n[1]-P})}if(!((c=e.modifiers)!=null&&c.hilite))return p(!1);let d=y(w("g"),{opacity:o.opacity}),l=y(w("g"),{filter:"url(#cg-filter-blur)"});return l.appendChild(Rr(r,n)),l.appendChild(p(!0)),d.appendChild(l),d.appendChild(p(!1)),d}function Kr(e){let o=y(w("marker"),{id:"arrowhead-"+e.key,orient:"auto",overflow:"visible",markerWidth:4,markerHeight:4,refX:e.key.startsWith("hilite")?1.86:2.05,refY:2});return o.appendChild(y(w("path"),{d:"M0,0 V4 L3,2 Z",fill:e.color})),o.setAttribute("cgKey",e.key),o}function Tr(e,o,r,n,i,t){var f;let p=.4*.75**e.text.length,d=Ho(r,n,i),l=t==="tr"?.4:0,c=y(w("g"),{transform:`translate(${d[0]+l},${d[1]-l})`,cgHash:o});c.appendChild(y(w("circle"),{r:.4/2,"fill-opacity":t?1:.8,"stroke-opacity":t?1:.7,"stroke-width":.03,fill:(f=e.fill)!=null?f:"#666",stroke:"white"}));let a=y(w("text"),{"font-size":p,"font-family":"Noto Sans","text-anchor":"middle",fill:"white",y:.13*.75**e.text.length});return a.innerHTML=e.text,c.appendChild(a),c}var pe=(e,o)=>o==="white"?e:[7-e[0],7-e[1]],To=(e,o)=>(e%o+o)%o,Oo=(e,o)=>To(e+o,16),No=e=>[...e].some(o=>[-3,-2,-1,1,2,3].some(r=>e.has(Oo(o,r)))),Ee=(e,o)=>!!e&&o.has(e)&&No(o.get(e)),w=e=>document.createElementNS("http://www.w3.org/2000/svg",e),qo=(e,o)=>e&&o.has(e)?o.get(e).size:0;function y(e,o){for(let r in o)Object.prototype.hasOwnProperty.call(o,r)&&e.setAttribute(r,o[r]);return e}var Bo=(e,o)=>o?{color:e.color,opacity:Math.round(e.opacity*10)/10,lineWidth:Math.round(o.lineWidth||e.lineWidth),key:[e.key,o.lineWidth].filter(r=>r).join("")}:e,Or=()=>[3/64,4/64],Nr=(e,o)=>(e.lineWidth||10)*(o?.85:1)/64;function Ro(e){var r;let o=(r=e.modifiers)==null?void 0:r.hilite;return{key:o&&`hilite-${o.replace("#","")}`,color:o}}var Wo=(e,o,r)=>(e.opacity||1)*(r?.6:o?.9:1),Br=e=>(e?20:10)/64;function ue(e,o){let r=Math.min(1,o.width/o.height),n=Math.min(1,o.height/o.width);return[(e[0]-3.5)*r,(3.5-e[1])*n]}function Rr(e,o){let r={from:[Math.floor(Math.min(e[0],o[0])),Math.floor(Math.min(e[1],o[1]))],to:[Math.ceil(Math.max(e[0],o[0])),Math.ceil(Math.max(e[1],o[1]))]};return y(w("rect"),{x:r.from[0],y:r.from[1],width:r.to[0]-r.from[0],height:r.to[1]-r.from[1],fill:"none",stroke:"none"})}var Lo=e=>To(Math.round(e*8/Math.PI),16),zo=(e,o)=>Math.atan2(o[1]-e[1],o[0]-e[0])+Math.PI,Wr=(e,o)=>Math.sqrt([e[0]-o[0],e[1]-o[1]].reduce((r,n)=>r+n*n,0));function Ho(e,o,r){let n=Wr(e,o),i=zo(e,o);if(r&&(n-=33/64,No(r))){n-=10/64;let t=Lo(i);t&1&&[-1,1].some(s=>r.has(Oo(t,s)))&&(n-=.4)}return[e[0]-Math.cos(i)*n,e[1]-Math.sin(i)*n].map(t=>t+.5)}function Io(e,o){e.innerHTML="",e.classList.add("cg-wrap");for(let c of Re)e.classList.toggle("orientation-"+c,o.orientation===c);e.classList.toggle("manipulable",!o.viewOnly);let r=D("cg-container");e.appendChild(r);let n=D("cg-board");r.appendChild(n);let i,t,s,p,d;if(o.drawable.visible&&([i,t]=["cg-shapes-below","cg-shapes"].map(c=>Fo(c,!0)),[s,p]=["cg-custom-below","cg-custom-svgs"].map(c=>Fo(c,!1)),d=D("cg-auto-pieces"),r.appendChild(i),r.appendChild(s),r.appendChild(t),r.appendChild(p),r.appendChild(d)),o.coordinates){let c=o.orientation==="black"?" black":"",a=o.ranksPosition==="left"?" left":"";if(o.coordinatesOnSquares){let f=o.orientation==="white"?m=>m+1:m=>8-m;_.forEach((m,u)=>r.appendChild(Ke(fe.map(g=>m+g),"squares rank"+f(u)+c+a,u%2===0?"black":"white")))}else r.appendChild(Ke(fe,"ranks"+c+a,o.ranksPosition==="right"==(o.orientation==="white")?"white":"black")),r.appendChild(Ke(_,"files"+c,F(o.orientation)))}let l;return!o.viewOnly&&o.draggable.enabled&&o.draggable.showGhost&&(l=D("piece","ghost"),B(l,!1),r.appendChild(l)),{board:n,container:r,wrap:e,ghost:l,shapes:t,shapesBelow:i,custom:p,customBelow:s,autoPieces:d}}function Fo(e,o){let r=y(w("svg"),{class:e,viewBox:o?"-4 -4 8 8":"-3.5 -3.5 8 8",preserveAspectRatio:"xMidYMid slice"});return o&&r.appendChild(Eo()),r.appendChild(w("g")),r}function Ke(e,o,r){let n=D("coords",o),i;return e.forEach((t,s)=>{let p=s%2===(r==="white"?0:1);i=D("coord",`coord-${p?"light":"dark"}`),i.textContent=t,n.appendChild(i)}),n}function Mn(e,o){e.dropmode={active:!0,piece:o},j(e)}function Sn(e){e.dropmode={active:!1}}function $o(e,o){if(!e.dropmode.active)return;q(e),E(e);let r=e.dropmode.piece;if(r){e.pieces.set("a0",r);let n=N(o),i=n&&K(n,v(e),e.dom.bounds());i&&le(e,"a0",i)}e.dom.redraw()}function Vo(e,o){let r=e.dom.elements.board;if("ResizeObserver"in window&&new ResizeObserver(o).observe(e.dom.elements.wrap),(e.disableContextMenu||e.drawable.enabled)&&r.addEventListener("contextmenu",i=>i.preventDefault()),e.viewOnly)return;let n=zr(e);r.addEventListener("touchstart",n,{passive:!1}),r.addEventListener("mousedown",n,{passive:!1})}function Go(e,o){let r=[];if("ResizeObserver"in window||r.push(J(document.body,"chessground.resize",o)),!e.viewOnly){let n=jo(e,bo,ao),i=jo(e,vo,po);for(let s of["touchmove","mousemove"])r.push(J(document,s,n));for(let s of["touchend","mouseup"])r.push(J(document,s,i));let t=()=>e.dom.bounds.clear();r.push(J(document,"scroll",t,{capture:!0,passive:!0})),r.push(J(window,"resize",t,{passive:!0}))}return()=>r.forEach(n=>n())}function J(e,o,r,n){return e.addEventListener(o,r,n),()=>e.removeEventListener(o,r,n)}var zr=e=>o=>{e.draggable.current?j(e):e.drawable.current?Ce(e):o.shiftKey||re(o)?e.drawable.enabled&&so(e,o):e.viewOnly||(e.dropmode.active?$o(e,o):ho(e,o))},jo=(e,o,r)=>n=>{e.drawable.current?e.drawable.enabled&&r(e,n):e.viewOnly||o(e,n)};function Zo(e){var Be;let o=v(e),r=$(e.dom.bounds()),n=e.dom.elements.board,i=e.pieces,t=e.animation.current,s=t?t.plan.anims:new Map,p=t?t.plan.fadings:new Map,d=e.draggable.current,l=new Set,c=new Map,a=$r(e),f=new Map,m,u,g,M,P,A,z,T,Z;for(u=n.firstChild;u;){if(m=u.cgKey,Uo(u))if(g=i.get(m),P=s.get(m),A=p.get(m),M=u.cgPiece,u.cgDragging&&(!d||d.orig!==m)&&(u.classList.remove("dragging"),x(u,r(h(m),o)),u.cgDragging=!1),!A&&u.cgFading&&(u.cgFading=!1,u.classList.remove("fading")),g){if(P&&u.cgAnimating&&M===ee(g)){let b=h(m);b[0]+=P[2],b[1]+=P[3],u.classList.add("anim"),x(u,r(b,o))}else u.cgAnimating&&(u.cgAnimating=!1,u.classList.remove("anim"),x(u,r(h(m),o)),e.addPieceZIndex&&(u.style.zIndex=Te(h(m),o)));M===ee(g)&&(!A||!u.cgFading)?l.add(m):A&&M===ee(A)?(u.classList.add("fading"),u.cgFading=!0):Oe(c,M,u)}else Oe(c,M,u);else if(Qo(u)){let b=u.className;a.get(m)===b?(B(u,!0),a.delete(m)):Oe(f,b,u)}u=u.nextSibling}for(let[b,V]of a){Z=(Be=f.get(V))==null?void 0:Be.pop();let S=r(h(b),o);if(Z)Z.cgKey=b,x(Z,S),B(Z,!0);else{let O=D("square",V);O.cgKey=b,x(O,S),n.insertBefore(O,n.firstChild)}}for(let[b,V]of f.entries())for(let S of V)B(S,!1);for(let[b,V]of i)if(P=s.get(b),!l.has(b))if(z=c.get(ee(V)),T=z&&z.pop(),T){T.cgKey=b,T.cgFading&&(T.classList.remove("fading"),T.cgFading=!1);let S=h(b);e.addPieceZIndex&&(T.style.zIndex=Te(S,o)),P&&(T.cgAnimating=!0,T.classList.add("anim"),S[0]+=P[2],S[1]+=P[3]),x(T,r(S,o))}else{let S=ee(V),O=D("piece",S),oe=h(b);O.cgPiece=S,O.cgKey=b,P&&(O.cgAnimating=!0,oe[0]+=P[2],oe[1]+=P[3]),x(O,r(oe,o)),e.addPieceZIndex&&(O.style.zIndex=Te(oe,o)),n.appendChild(O)}for(let b of c.values())Fr(e,b)}function _o(e){let o=v(e),r=$(e.dom.bounds()),n=e.dom.elements.board.firstChild;for(;n;)(Uo(n)&&!n.cgAnimating||Qo(n))&&x(n,r(h(n.cgKey),o)),n=n.nextSibling}function Ne(e){var s,p;let o=e.dom.elements.wrap.getBoundingClientRect(),r=e.dom.elements.container,n=o.height/o.width,i=Math.floor(o.width*window.devicePixelRatio/8)*8/window.devicePixelRatio,t=i*n;r.style.width=i+"px",r.style.height=t+"px",e.dom.bounds.clear(),(s=e.addDimensionsCssVarsTo)==null||s.style.setProperty("---cg-width",i+"px"),(p=e.addDimensionsCssVarsTo)==null||p.style.setProperty("---cg-height",t+"px")}var Uo=e=>e.tagName==="PIECE",Qo=e=>e.tagName==="SQUARE";function Fr(e,o){for(let r of o)e.dom.elements.board.removeChild(r)}function Te(e,o){let n=e[1];return`${o?10-n:3+n}`}var ee=e=>`${e.color} ${e.role}`,Ir=(e,o)=>{var r;return(r=e.lastMove)!=null&&r[1]&&!e.pieces.has(e.lastMove[1])&&e.lastMove[0][0]==="e"&&["h","a"].includes(e.lastMove[1][0])&&e.lastMove[0][1]===e.lastMove[1][1]&&Ue(...h(e.lastMove[0]),...h(e.lastMove[1])).some(n=>e.pieces.has(n))?(o>e.lastMove[0]?"g":"c")+o[1]:o};function $r(e){var i,t,s,p,d;let o=new Map;if(e.lastMove&&e.highlight.lastMove)for(let[l,c]of e.lastMove.entries())L(o,l===1?Ir(e,c):c,"last-move");if(e.check&&e.highlight.check&&L(o,e.check,"check"),e.selected&&(L(o,e.selected,"selected"),e.movable.showDests)){for(let l of(t=(i=e.movable.dests)==null?void 0:i.get(e.selected))!=null?t:[])L(o,l,"move-dest"+(e.pieces.has(l)?" oc":""));for(let l of(d=(p=(s=e.premovable.customDests)==null?void 0:s.get(e.selected))!=null?p:e.premovable.dests)!=null?d:[])L(o,l,"premove-dest"+(e.pieces.has(l)?" oc":""))}let r=e.premovable.current;if(r)for(let l of r)L(o,l,"current-premove");else e.predroppable.current&&L(o,e.predroppable.current.key,"current-premove");let n=e.exploding;if(n)for(let l of n.keys)L(o,l,"exploding"+n.stage);return e.highlight.custom&&e.highlight.custom.forEach((l,c)=>{L(o,c,l)}),o}function L(e,o,r){let n=e.get(o);n?e.set(o,`${n} ${r}`):e.set(o,r)}function Oe(e,o,r){let n=e.get(o);n?n.push(r):e.set(o,[r])}function Yo(e,o,r){let n=new Map,i=[];for(let p of e)n.set(p.hash,!1);let t=o.firstElementChild,s;for(;t;)s=t.getAttribute("cgHash"),n.has(s)?n.set(s,!0):i.push(t),t=t.nextElementSibling;for(let p of i)o.removeChild(p);for(let p of e)n.get(p.hash)||o.appendChild(r(p))}function Xo(e,o){let n=e.drawable.autoShapes.filter(i=>i.piece).map(i=>({shape:i,hash:Vr(i),current:!1,pendingErase:!1}));Yo(n,o,i=>jr(e,i,e.dom.bounds()))}function Jo(e){var i;let o=v(e),r=$(e.dom.bounds()),n=(i=e.dom.elements.autoPieces)==null?void 0:i.firstChild;for(;n;)me(n,r(h(n.cgKey),o),n.cgScale),n=n.nextSibling}function jr(e,{shape:o,hash:r},n){var l,c,a;let i=o.orig,t=(l=o.piece)==null?void 0:l.role,s=(c=o.piece)==null?void 0:c.color,p=(a=o.piece)==null?void 0:a.scale,d=D("piece",`${t} ${s}`);return d.setAttribute("cgHash",r),d.cgKey=i,d.cgScale=p,me(d,$(n)(h(i),v(e)),p),d}var Vr=e=>{var o,r,n;return[e.orig,(o=e.piece)==null?void 0:o.role,(r=e.piece)==null?void 0:r.color,(n=e.piece)==null?void 0:n.scale].join(",")};function Fn(e,o){let r=xo();de(r,o||{});function n(){let i="dom"in r?r.dom.unbind:void 0,t=Io(e,r),s=Fe(()=>t.board.getBoundingClientRect()),p=c=>{Zo(l),t.autoPieces&&Xo(l,t.autoPieces),!c&&t.shapes&&Ko(l,t)},d=()=>{Ne(l),_o(l),t.autoPieces&&Jo(l)},l=r;return l.dom={elements:t,bounds:s,redraw:Zr(p),redrawNow:p,unbind:i},l.drawable.prevSvgHash="",Ne(l),p(!1),Vo(l,d),i||(l.dom.unbind=Go(l,d)),l.events.insert&&l.events.insert(t),l}return So(n(),n)}function Zr(e){let o=!1;return()=>{o||(o=!0,requestAnimationFrame(()=>{e(),o=!1}))}}export{ae as a,go as b,Mn as c,Sn as d,Fn as e};
