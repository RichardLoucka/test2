import{a as d}from"./lib.K5BZ6UV3.js";import{l as P}from"./lib.PA5MQ22V.js";import{H as T,P as k,R as f,a as y,r as w,u as S}from"./lib.RD75MZYZ.js";var O=M({db:"log--db",store:"log",version:3,upgrade:(n,e)=>e==null?void 0:e.clear()},parseInt(localStorage.getItem("log.window")||"100"));function M(n,e){var p,g;let t,s,r=0,i=.001,l=new Promise(a=>s=a);(g=(p=Error.prototype).toJSON)!=null||(p.toJSON=function(){return{[this.name]:this.message,stack:this.stack}}),k(n).then(async a=>{t=a,s()}).catch(a=>{console.error(a),f(n),s()});function u(a){return!a||typeof a=="string"?String(a):JSON.stringify(a)}let h=(...a)=>{n.store==="log"&&console.log(...a);let v=(n.store==="log"&&site.info?`#${site.info.commit.substring(0,7)} - `:"")+a.map(u).join(" "),c=Date.now();return c===r?(c+=i,i+=.001):(i=.001,r=c),l.then(()=>t==null?void 0:t.put(c,v)).catch(console.error)};return h.clear=async()=>{await l,await(t==null?void 0:t.clear()),r=0},h.get=async()=>{if(await l,!t)return"";try{let c=await t.list();e>=0&&c.length>e&&await t.remove(IDBKeyRange.upperBound(c[c.length-e],!0))}catch(c){return console.error(c),t.clear(),f(n),""}let[a,v]=await Promise.all([t.list(),t.getMany()]);return a.map((c,D)=>`${new Date(c).toISOString().replace(/[TZ]/g," ")}${v[D]}`).join(`
`)},h}function x(n,e,t){let s=["mousemove","touchstart"],r=!1,i=!0,l=performance.now(),u=()=>{i||t(),i=!0,l=performance.now(),p()},h=()=>{r||(s.forEach(g=>document.addEventListener(g,u)),r=!0)},p=()=>{r&&(s.forEach(g=>document.removeEventListener(g,u)),r=!1)};setInterval(()=>{i&&performance.now()-l>n&&(e(),i=!1),h()},1e4)}function E(n=1e3){let e,t,s=!1;return i(),{get wasSuspended(){return s},reset(){s=!1,clearTimeout(t),i()}};function r(){performance.now()-e>n+400?s=!0:i()}function i(){e=performance.now(),t=setTimeout(r,n)}}var L=class{constructor(){this.cleanupTasks=[]}addListener(e,t,s,r){e.addEventListener(t,s,r),this.cleanupTasks.push(()=>e.removeEventListener(t,s,r))}addCleanupTask(e){this.cleanupTasks.push(e)}cleanup(){for(let e of this.cleanupTasks)e();this.cleanupTasks.length=0}};var o;function V(){setTimeout(()=>{o||U("/socket/v5",!1)},500)}function U(n,e,t={}){return o=new m(n,e,t)}function I(){o==null||o.destroy(),o=void 0}function Q(n,e,t,s){o==null||o.send(n,e,t,s)}function G(n){o==null||o.sign(n)}function Z(){var n;return(n=o==null?void 0:o.getVersion())!=null?n:!1}function q(){var n;return(n=o==null?void 0:o.pingInterval())!=null?n:0}function F(){var n;return(n=o==null?void 0:o.averageLag)!=null?n:0}var C=()=>!("onLine"in navigator)||navigator.onLine,m=class{constructor(e,t,s={}){this.url=e;this.averageLag=0;this.ackable=new b((e,t,s)=>this.send(e,t,s));this.lastPingTime=performance.now();this.pongCount=0;this.tryOtherUrl=!1;this.storage=S.make("surl18",1800*1e3);this.resendWhenOpen=[];this.baseUrls=document.body.dataset.socketDomains.split(",");this.heartbeat=E(1e3);this.sign=e=>{this._sign=e,this.ackable.sign(e)};this.connect=()=>{this.destroy(),this.lastUrl=P(this.options.protocol+"//"+this.nextBaseUrl()+this.url,{...this.settings.params,v:this.version===!1?void 0:this.version}),this.debug("connection attempt to "+this.lastUrl);try{let e=this.ws=new WebSocket(this.lastUrl);e.onerror=t=>this.onError(t),e.onclose=this.onClose,e.onopen=()=>{this.lastUrl=e.url,this.debug("connected to "+this.lastUrl);let t=document.body.classList;d.past("socket.hasConnected")&&t.add("reconnected"),t.remove("offline"),t.add("online"),this.onSuccess(),this.pingNow(),this.resendWhenOpen.forEach(([s,r,i])=>this.send(s,r,i)),this.resendWhenOpen=[],d.emit("socket.open"),this.ackable.resend()},e.onmessage=t=>{if(t.data==0)return this.pong();let s=JSON.parse(t.data);s.t==="n"&&this.pong(),this.handle(s)}}catch(e){this.onClose({code:4e3,reason:String(e)})}this.scheduleConnect()};this.send=(e,t,s={},r=!1)=>{let i={t:e};t!==void 0&&(s.withLag&&(t.l=Math.round(this.averageLag)),y(s.millis)&&s.millis>=0&&(t.s=Math.round(s.millis*.1).toString(36)),i.d=t),s.ackable&&(i.d=i.d||{},this.ackable.register(e,i.d));let l=JSON.stringify(i);if(!(e==="racerScore"&&s.sign!==this._sign)){if(e==="move"&&s.sign!==this._sign){let u;try{u=new Error().stack.split(`
`).join(" / ").replace(/\s+/g," ")}catch(h){u=`${h.message} ${navigator.userAgent}`}u.includes("round.nvui")||setTimeout(()=>{T(`socket.rep.${Math.round(Date.now()/1e3/3600/3)}`)?this.send("rep",{n:`soc: ${l} ${u}`}):I()},1e4)}this.debug("send "+l),!this.ws||this.ws.readyState===WebSocket.CONNECTING?r||this.resendWhenOpen.push([e,i.d,s]):this.ws.send(l)}};this.scheduleConnect=(e=this.options.pongTimeout)=>{this.options.idle&&(e=10*1e3+Math.random()*10*1e3),clearTimeout(this.pingSchedule),clearTimeout(this.connectSchedule),this.connectSchedule=setTimeout(()=>{var t,s,r,i;document.body.classList.add("offline"),document.body.classList.remove("online"),C()?$("#network-status").text((s=(t=i18n==null?void 0:i18n.site)==null?void 0:t.reconnecting)!=null?s:"Reconnecting"):$("#network-status").text((i=(r=i18n==null?void 0:i18n.site)==null?void 0:r.noNetwork)!=null?i:"Offline"),this.tryOtherUrl=!0,this.connect()},e)};this.schedulePing=e=>{clearTimeout(this.pingSchedule),this.pingSchedule=setTimeout(this.pingNow,e)};this.pingNow=()=>{clearTimeout(this.pingSchedule),clearTimeout(this.connectSchedule);let e=this.options.isAuth&&this.pongCount%10===2?JSON.stringify({t:"p",l:Math.round(.1*this.averageLag)}):"null";try{this.ws.send(e),this.lastPingTime=performance.now()}catch(t){this.debug(t,!0)}this.scheduleConnect()};this.computePingDelay=()=>this.options.pingDelay+(this.options.idle?1e3:0);this.pong=()=>{clearTimeout(this.connectSchedule),this.schedulePing(this.computePingDelay());let e=Math.min(performance.now()-this.lastPingTime,1e4);this.pongCount++;let t=this.pongCount>4?.1:1/this.pongCount;this.averageLag+=t*(e-this.averageLag),d.emit("socket.lag",this.averageLag)};this.handle=(e,t=10)=>{if(e.v&&this.version!==!1){if(e.v<=this.version){this.debug("already has event "+e.v);return}if(e.v>this.version+1){t>0?(console.debug("version gap, retrying",e.v,this.version,t),setTimeout(()=>this.handle(e,t-1),200)):(O(`${window.location.pathname}: version incoming ${e.v} vs current ${this.version}`),site.reload());return}this.version=e.v}switch(e.t||!1){case!1:break;case"resync":setTimeout(()=>site.reload("lila-ws resync"),500);break;case"ack":this.ackable.onServerAck(e.d);break;case"batch":e.d.forEach(this.handle);break;default:this.settings.receive&&this.settings.receive(e.t,e.d)||this.settings.events[e.t]&&this.settings.events[e.t](e.d||null,e)||d.emit("socket.in."+e.t,e.d,e)}};this.debug=(e,t=!1)=>{(t||this.options.debug)&&console.debug(e)};this.destroy=()=>{clearTimeout(this.pingSchedule),clearTimeout(this.connectSchedule),this.disconnect(),this.ws=void 0};this.disconnect=()=>{let e=this.ws;e&&(this.debug("Disconnect"),e.onerror=e.onclose=e.onopen=e.onmessage=()=>{},e.close())};this.onError=e=>{this.heartbeat.wasSuspended||(this.options.debug=!0,this.debug(`error: ${e} ${JSON.stringify(e)}`))};this.onClose=e=>{if(d.emit("socket.close"),this.heartbeat.wasSuspended)return this.onSuspended();this.ws&&(this.debug("Will autoreconnect in "+this.options.autoReconnectDelay),this.scheduleConnect(this.options.autoReconnectDelay)),!(e.wasClean&&e.code<1002)&&(C()&&(this.tryOtherUrl=!0),clearTimeout(this.pingSchedule))};this.onSuccess=()=>{if(d.past("socket.hasConnected"))return;d.complete("socket.hasConnected");let e;x(600*1e3,()=>{this.options.idle=!0,e=setTimeout(this.destroy,7200*1e3)},()=>{this.options.idle=!1,this.ws?clearTimeout(e):this.options.reloadOnResume&&location.reload()})};this.nextBaseUrl=()=>{let e=this.storage.get();if(!e||!this.baseUrls.includes(e))e=this.baseUrls[Math.floor(Math.random()*this.baseUrls.length)],this.storage.set(e);else if(this.tryOtherUrl){let t=this.baseUrls.findIndex(s=>s===e);e=this.baseUrls[(t+1)%this.baseUrls.length],this.storage.set(e)}return this.tryOtherUrl=!1,e};this.pingInterval=()=>this.computePingDelay()+this.averageLag;this.getVersion=()=>this.version;this.options={idle:!1,debug:!1,pongTimeout:9e3,autoReconnectDelay:3500,protocol:location.protocol==="https:"?"wss:":"ws:",isAuth:!!w(),...s.options||{},pingDelay:2500},this.settings={receive:s.receive,events:s.events||{},params:{sri:site.sri,from:"website",...s.params||{}}},this.version=t,d.on("socket.send",this.send),this.connect()}onSuspended(){this.heartbeat.reset(),clearTimeout(this.pingSchedule),clearTimeout(this.connectSchedule),this.connect()}},b=class{constructor(e){this.send=e;this.currentId=1;this.messages=[];this.sign=e=>this._sign=e;this.resend=()=>{let e=performance.now()-2500;this.messages.forEach(t=>{t.at<e&&this.send(t.t,t.d,{sign:this._sign})})};this.register=(e,t)=>{t.a=this.currentId++,this.messages.push({t:e,d:t,at:performance.now()})};this.onServerAck=e=>{this.messages=this.messages.filter(t=>t.d.a!==e)};setInterval(this.resend,1200)}};export{x as a,L as b,O as c,M as d,V as e,U as f,I as g,Q as h,G as i,Z as j,q as k,F as l};
