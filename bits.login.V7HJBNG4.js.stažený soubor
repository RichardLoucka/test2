import{N as c,O as w,S as y}from"./lib.IUYHUHRA.js";import"./lib.MSWDVTRS.js";import"./lib.BXUODSEE.js";import"./lib.TPNYGJOG.js";import"./lib.JDGIJSRT.js";import"./lib.SM2D2BUH.js";import"./lib.BDXL3LOQ.js";import"./lib.PUZNKYJD.js";import"./lib.K7BTCZAK.js";import"./lib.K5BZ6UV3.js";import"./lib.LE4HQ5U6.js";import{b as u,c as p,f as g,l as b}from"./lib.PA5MQ22V.js";import{D as m,N as h}from"./lib.RD75MZYZ.js";import"./lib.XNXLGS2X.js";function P(e){e==="login"?S():e==="signup"?v():k(),c()}var f=class{constructor(){this.historyStorage=m("login.history",()=>[]);this.now=()=>Math.round(Date.now()/1e3);this.add=()=>{let s=this.now();this.historyStorage([s,...this.historyStorage().filter(o=>o>s-30)])};this.lockSeconds=()=>{let s=this.now(),o=this.historyStorage().filter(a=>a>s-30);if(o.length>=3)return Math.max(0,o[o.length-1]+30-s)}}};function S(){let e=".auth-login form",s=new f,o=(a,i)=>a.prop("disabled",!i).toggleClass("disabled",!i);(function a(){let i=document.querySelector(e),n=$(i);if(s.lockSeconds()){let d=n.find(".submit"),r=o(d,!1).text(),t=()=>{let l=s.lockSeconds();l?(d.text(""+l),setTimeout(t,1e3)):d.text(r).prop("disabled",!1).removeClass("disabled")};t()}i.addEventListener("submit",d=>{d.preventDefault(),o(n.find(".submit"),!1),fetch(i.action,{...u,headers:p,method:"post",body:new FormData(i)}).then(r=>r.text().then(t=>[r,t])).then(([r,t])=>{if(t==="MissingTotpToken"||t==="InvalidTotpToken")n.find(".one-factor").hide(),n.find(".two-factor").removeClass("none"),requestAnimationFrame(()=>n.find(".two-factor input").val("")[0].focus()),o(n.find(".submit"),!0),t==="InvalidTotpToken"&&n.find(".two-factor .error").removeClass("none");else if(r.ok)location.href=t.startsWith("ok:")?t.slice(3):"/";else try{let l=$(t).find(e);l.length?(s.add(),n.replaceWith(l),c(),a()):y((t||r.statusText).slice(0,300)+". Please wait some time before trying again.").then(()=>o(n.find(".submit"),!0))}catch(l){console.warn(l),n.html(t)}})})})()}function v(){let e=$("#signup-form"),s=e.find(".username-exists"),o=e.find('input[name="username"]').on("change keyup paste",()=>{s.addClass("none"),a()}),a=h(()=>{let i=o.val();i.length>=3&&g(b("/api/player/autocomplete",{term:i,exists:1})).then(n=>s.toggleClass("none",!n))},300);e.on("submit",()=>{if(e.find('[name="h-captcha-response"]').val()||!e.hasClass("h-captcha-enabled"))e.find("button.submit").prop("disabled",!0).removeAttr("data-icon").addClass("frameless").html(w);else return!1}),site.asset.loadEsm("bits.passwordComplexity",{init:"form3-password"})}function k(){site.asset.loadEsm("bits.passwordComplexity",{init:"form3-newPasswd1"})}export{P as initModule};
