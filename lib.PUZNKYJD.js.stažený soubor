import{b as tt}from"./lib.XNXLGS2X.js";var D=["a","b","c","d","e","f","g","h"],Z=["1","2","3","4","5","6","7","8"];var C=["white","black"],R=["pawn","knight","bishop","rook","queen","king"],Et=["a","h"],A=e=>"role"in e,Zt=e=>"from"in e;var u=e=>e!==void 0,p=e=>e==="white"?"black":"white",v=e=>e>>3,g=e=>e&7,et=(e,t)=>0<=e&&e<8&&0<=t&&t<8?e+8*t:void 0,P=e=>{switch(e){case"pawn":return"p";case"knight":return"n";case"bishop":return"b";case"rook":return"r";case"queen":return"q";case"king":return"k"}};function I(e){switch(e.toLowerCase()){case"p":return"pawn";case"n":return"knight";case"b":return"bishop";case"r":return"rook";case"q":return"queen";case"k":return"king";default:return}}function q(e){if(e.length===2)return et(e.charCodeAt(0)-97,e.charCodeAt(1)-49)}var y=e=>D[g(e)]+Z[v(e)],Ce=e=>{if(e[1]==="@"&&e.length===4){let t=I(e[0]),r=q(e.slice(2));if(t&&u(r))return{role:t,to:r}}else if(e.length===4||e.length===5){let t=q(e.slice(0,2)),r=q(e.slice(2,4)),s;if(e.length===5&&(s=I(e[4]),!s))return;if(u(t)&&u(r))return{from:t,to:r,promotion:s}}};var Re=e=>A(e)?`${P(e.role).toUpperCase()}@${y(e.to)}`:y(e.from)+y(e.to)+(e.promotion?P(e.promotion):""),J=(e,t)=>e==="white"?t==="a"?2:6:t==="a"?58:62,rt=(e,t)=>e==="white"?t==="a"?3:5:t==="a"?59:61;var st=class{unwrap(t,r){let s=this._chain(n=>f.ok(t?t(n):n),n=>r?f.ok(r(n)):f.err(n));if(s.isErr)throw s.error;return s.value}map(t,r){return this._chain(s=>f.ok(t(s)),s=>f.err(r?r(s):s))}chain(t,r){return this._chain(t,r!=null?r:(s=>f.err(s)))}},Ct=class extends st{constructor(t){super(),this.value=t,this.isOk=!0,this.isErr=!1}_chain(t,r){return t(this.value)}},Rt=class extends st{constructor(t){super(),this.error=t,this.isOk=!1,this.isErr=!0}_chain(t,r){return r(this.error)}},f;(function(e){function t(n){return new Ct(n)}e.ok=t;function r(n){return new Rt(n||new Error)}e.err=r;function s(n){if(Array.isArray(n)){let c=[];for(let l=0;l<n.length;l++){let h=n[l];if(h.isErr)return h;c.push(h.value)}return e.ok(c)}let i={},a=Object.keys(n);for(let c=0;c<a.length;c++){let l=n[a[c]];if(l.isErr)return l;i[a[c]]=l.value}return e.ok(i)}e.all=s})(f||(f={}));var Jt=e=>(e=e-(e>>>1&1431655765),e=(e&858993459)+(e>>>2&858993459),Math.imul(e+(e>>>4)&252645135,16843009)>>24),At=e=>(e=e>>>8&16711935|(e&16711935)<<8,e>>>16&65535|(e&65535)<<16),Xt=e=>(e=e>>>1&1431655765|(e&1431655765)<<1,e=e>>>2&858993459|(e&858993459)<<2,e=e>>>4&252645135|(e&252645135)<<4,At(e)),o=class e{constructor(t,r){this.lo=t|0,this.hi=r|0}static fromSquare(t){return t>=32?new e(0,1<<t-32):new e(1<<t,0)}static fromRank(t){return new e(255,0).shl64(8*t)}static fromFile(t){return new e(16843009<<t,16843009<<t)}static empty(){return new e(0,0)}static full(){return new e(4294967295,4294967295)}static corners(){return new e(129,2164260864)}static center(){return new e(402653184,24)}static backranks(){return new e(255,4278190080)}static backrank(t){return t==="white"?new e(255,0):new e(0,4278190080)}static lightSquares(){return new e(1437226410,1437226410)}static darkSquares(){return new e(2857740885,2857740885)}complement(){return new e(~this.lo,~this.hi)}xor(t){return new e(this.lo^t.lo,this.hi^t.hi)}union(t){return new e(this.lo|t.lo,this.hi|t.hi)}intersect(t){return new e(this.lo&t.lo,this.hi&t.hi)}diff(t){return new e(this.lo&~t.lo,this.hi&~t.hi)}intersects(t){return this.intersect(t).nonEmpty()}isDisjoint(t){return this.intersect(t).isEmpty()}supersetOf(t){return t.diff(this).isEmpty()}subsetOf(t){return this.diff(t).isEmpty()}shr64(t){return t>=64?e.empty():t>=32?new e(this.hi>>>t-32,0):t>0?new e(this.lo>>>t^this.hi<<32-t,this.hi>>>t):this}shl64(t){return t>=64?e.empty():t>=32?new e(0,this.lo<<t-32):t>0?new e(this.lo<<t,this.hi<<t^this.lo>>>32-t):this}bswap64(){return new e(At(this.hi),At(this.lo))}rbit64(){return new e(Xt(this.hi),Xt(this.lo))}minus64(t){let r=this.lo-t.lo,s=(r&t.lo&1)+(t.lo>>>1)+(r>>>1)>>>31;return new e(r,this.hi-(t.hi+s))}equals(t){return this.lo===t.lo&&this.hi===t.hi}size(){return Jt(this.lo)+Jt(this.hi)}isEmpty(){return this.lo===0&&this.hi===0}nonEmpty(){return this.lo!==0||this.hi!==0}has(t){return(t>=32?this.hi&1<<t-32:this.lo&1<<t)!==0}set(t,r){return r?this.with(t):this.without(t)}with(t){return t>=32?new e(this.lo,this.hi|1<<t-32):new e(this.lo|1<<t,this.hi)}without(t){return t>=32?new e(this.lo,this.hi&~(1<<t-32)):new e(this.lo&~(1<<t),this.hi)}toggle(t){return t>=32?new e(this.lo,this.hi^1<<t-32):new e(this.lo^1<<t,this.hi)}last(){if(this.hi!==0)return 63-Math.clz32(this.hi);if(this.lo!==0)return 31-Math.clz32(this.lo)}first(){if(this.lo!==0)return 31-Math.clz32(this.lo&-this.lo);if(this.hi!==0)return 63-Math.clz32(this.hi&-this.hi)}withoutFirst(){return this.lo!==0?new e(this.lo&this.lo-1,this.hi):new e(0,this.hi&this.hi-1)}moreThanOne(){return this.hi!==0&&this.lo!==0||(this.lo&this.lo-1)!==0||(this.hi&this.hi-1)!==0}singleSquare(){return this.moreThanOne()?void 0:this.last()}*[Symbol.iterator](){let t=this.lo,r=this.hi;for(;t!==0;){let s=31-Math.clz32(t&-t);t^=1<<s,yield s}for(;r!==0;){let s=31-Math.clz32(r&-r);r^=1<<s,yield 32+s}}*reversed(){let t=this.lo,r=this.hi;for(;r!==0;){let s=31-Math.clz32(r);r^=1<<s,yield 32+s}for(;t!==0;){let s=31-Math.clz32(t);t^=1<<s,yield s}}};var nt=(e,t)=>{let r=o.empty();for(let s of t){let n=e+s;0<=n&&n<64&&Math.abs(g(e)-g(n))<=2&&(r=r.with(n))}return r},F=e=>{let t=[];for(let r=0;r<64;r++)t[r]=e(r);return t},Ae=F(e=>nt(e,[-9,-8,-7,-1,1,7,8,9])),qe=F(e=>nt(e,[-17,-15,-10,-6,6,10,15,17])),Oe={white:F(e=>nt(e,[7,9])),black:F(e=>nt(e,[-7,-9]))},B=e=>Ae[e],H=e=>qe[e],K=(e,t)=>Oe[e][t],qt=F(e=>o.fromFile(g(e)).without(e)),Ot=F(e=>o.fromRank(v(e)).without(e)),vt=F(e=>{let t=new o(134480385,2151686160),r=8*(v(e)-g(e));return(r>=0?t.shl64(r):t.shr64(-r)).without(e)}),Mt=F(e=>{let t=new o(270549120,16909320),r=8*(v(e)+g(e)-7);return(r>=0?t.shl64(r):t.shr64(-r)).without(e)}),Nt=(e,t,r)=>{let s=r.intersect(t),n=s.bswap64();return s=s.minus64(e),n=n.minus64(e.bswap64()),s.xor(n.bswap64()).intersect(t)},ve=(e,t)=>Nt(o.fromSquare(e),qt[e],t),Me=(e,t)=>{let r=Ot[e],s=t.intersect(r),n=s.rbit64();return s=s.minus64(o.fromSquare(e)),n=n.minus64(o.fromSquare(63-e)),s.xor(n.rbit64()).intersect(r)},L=(e,t)=>{let r=o.fromSquare(e);return Nt(r,vt[e],t).xor(Nt(r,Mt[e],t))},U=(e,t)=>ve(e,t).xor(Me(e,t)),X=(e,t)=>L(e,t).xor(U(e,t)),it=(e,t,r)=>{switch(e.role){case"pawn":return K(e.color,t);case"knight":return H(t);case"bishop":return L(t,r);case"rook":return U(t,r);case"queen":return X(t,r);case"king":return B(t)}},Pt=(e,t)=>{let r=o.fromSquare(t);return Ot[e].intersects(r)?Ot[e].with(e):Mt[e].intersects(r)?Mt[e].with(e):vt[e].intersects(r)?vt[e].with(e):qt[e].intersects(r)?qt[e].with(e):o.empty()},V=(e,t)=>Pt(e,t).intersect(o.full().shl64(e).xor(o.full().shl64(t))).withoutFirst();var M=class e{constructor(){}static default(){let t=new e;return t.reset(),t}reset(){this.occupied=new o(65535,4294901760),this.promoted=o.empty(),this.white=new o(65535,0),this.black=new o(0,4294901760),this.pawn=new o(65280,16711680),this.knight=new o(66,1107296256),this.bishop=new o(36,603979776),this.rook=new o(129,2164260864),this.queen=new o(8,134217728),this.king=new o(16,268435456)}static empty(){let t=new e;return t.clear(),t}clear(){this.occupied=o.empty(),this.promoted=o.empty();for(let t of C)this[t]=o.empty();for(let t of R)this[t]=o.empty()}clone(){let t=new e;t.occupied=this.occupied,t.promoted=this.promoted;for(let r of C)t[r]=this[r];for(let r of R)t[r]=this[r];return t}getColor(t){if(this.white.has(t))return"white";if(this.black.has(t))return"black"}getRole(t){for(let r of R)if(this[r].has(t))return r}get(t){let r=this.getColor(t);if(!r)return;let s=this.getRole(t),n=this.promoted.has(t);return{color:r,role:s,promoted:n}}take(t){let r=this.get(t);return r&&(this.occupied=this.occupied.without(t),this[r.color]=this[r.color].without(t),this[r.role]=this[r.role].without(t),r.promoted&&(this.promoted=this.promoted.without(t))),r}set(t,r){let s=this.take(t);return this.occupied=this.occupied.with(t),this[r.color]=this[r.color].with(t),this[r.role]=this[r.role].with(t),r.promoted&&(this.promoted=this.promoted.with(t)),s}has(t){return this.occupied.has(t)}*[Symbol.iterator](){for(let t of this.occupied)yield[t,this.get(t)]}pieces(t,r){return this[t].intersect(this[r])}rooksAndQueens(){return this.rook.union(this.queen)}bishopsAndQueens(){return this.bishop.union(this.queen)}steppers(){return this.knight.union(this.pawn).union(this.king)}sliders(){return this.bishop.union(this.rook).union(this.queen)}kingOf(t){return this.pieces(t,"king").singleSquare()}};var k;(function(e){e.Empty="ERR_EMPTY",e.OppositeCheck="ERR_OPPOSITE_CHECK",e.PawnsOnBackrank="ERR_PAWNS_ON_BACKRANK",e.Kings="ERR_KINGS",e.Variant="ERR_VARIANT"})(k||(k={}));var m=class extends Error{},Pe=(e,t,r,s)=>r[t].intersect(U(e,s).intersect(r.rooksAndQueens()).union(L(e,s).intersect(r.bishopsAndQueens())).union(H(e).intersect(r.knight)).union(B(e).intersect(r.king)).union(K(p(t),e).intersect(r.pawn))),N=class e{constructor(){}static default(){let t=new e;return t.castlingRights=o.corners(),t.rook={white:{a:0,h:7},black:{a:56,h:63}},t.path={white:{a:new o(14,0),h:new o(96,0)},black:{a:new o(0,234881024),h:new o(0,1610612736)}},t}static empty(){let t=new e;return t.castlingRights=o.empty(),t.rook={white:{a:void 0,h:void 0},black:{a:void 0,h:void 0}},t.path={white:{a:o.empty(),h:o.empty()},black:{a:o.empty(),h:o.empty()}},t}clone(){let t=new e;return t.castlingRights=this.castlingRights,t.rook={white:{a:this.rook.white.a,h:this.rook.white.h},black:{a:this.rook.black.a,h:this.rook.black.h}},t.path={white:{a:this.path.white.a,h:this.path.white.h},black:{a:this.path.black.a,h:this.path.black.h}},t}add(t,r,s,n){let i=J(t,r),a=rt(t,r);this.castlingRights=this.castlingRights.with(n),this.rook[t][r]=n,this.path[t][r]=V(n,a).with(a).union(V(s,i).with(i)).without(s).without(n)}static fromSetup(t){let r=e.empty(),s=t.castlingRights.intersect(t.board.rook);for(let n of C){let i=o.backrank(n),a=t.board.kingOf(n);if(!u(a)||!i.has(a))continue;let c=s.intersect(t.board[n]).intersect(i),l=c.first();u(l)&&l<a&&r.add(n,"a",a,l);let h=c.last();u(h)&&a<h&&r.add(n,"h",a,h)}return r}discardRook(t){if(this.castlingRights.has(t)){this.castlingRights=this.castlingRights.without(t);for(let r of C)for(let s of Et)this.rook[r][s]===t&&(this.rook[r][s]=void 0)}}discardColor(t){this.castlingRights=this.castlingRights.diff(o.backrank(t)),this.rook[t].a=void 0,this.rook[t].h=void 0}},O=class{constructor(t){this.rules=t}reset(){this.board=M.default(),this.pockets=void 0,this.turn="white",this.castles=N.default(),this.epSquare=void 0,this.remainingChecks=void 0,this.halfmoves=0,this.fullmoves=1}setupUnchecked(t){this.board=t.board.clone(),this.board.promoted=o.empty(),this.pockets=void 0,this.turn=t.turn,this.castles=N.fromSetup(t),this.epSquare=Be(this,t.epSquare),this.remainingChecks=void 0,this.halfmoves=t.halfmoves,this.fullmoves=t.fullmoves}kingAttackers(t,r,s){return Pe(t,r,this.board,s)}playCaptureAt(t,r){this.halfmoves=0,r.role==="rook"&&this.castles.discardRook(t),this.pockets&&this.pockets[p(r.color)][r.promoted?"pawn":r.role]++}ctx(){let t=this.isVariantEnd(),r=this.board.kingOf(this.turn);if(!u(r))return{king:r,blockers:o.empty(),checkers:o.empty(),variantEnd:t,mustCapture:!1};let s=U(r,o.empty()).intersect(this.board.rooksAndQueens()).union(L(r,o.empty()).intersect(this.board.bishopsAndQueens())).intersect(this.board[p(this.turn)]),n=o.empty();for(let a of s){let c=V(r,a).intersect(this.board.occupied);c.moreThanOne()||(n=n.union(c))}let i=this.kingAttackers(r,p(this.turn),this.board.occupied);return{king:r,blockers:n,checkers:i,variantEnd:t,mustCapture:!1}}clone(){var t,r;let s=new this.constructor;return s.board=this.board.clone(),s.pockets=(t=this.pockets)===null||t===void 0?void 0:t.clone(),s.turn=this.turn,s.castles=this.castles.clone(),s.epSquare=this.epSquare,s.remainingChecks=(r=this.remainingChecks)===null||r===void 0?void 0:r.clone(),s.halfmoves=this.halfmoves,s.fullmoves=this.fullmoves,s}validate(){if(this.board.occupied.isEmpty())return f.err(new m(k.Empty));if(this.board.king.size()!==2)return f.err(new m(k.Kings));if(!u(this.board.kingOf(this.turn)))return f.err(new m(k.Kings));let t=this.board.kingOf(p(this.turn));return u(t)?this.kingAttackers(t,this.turn,this.board.occupied).nonEmpty()?f.err(new m(k.OppositeCheck)):o.backranks().intersects(this.board.pawn)?f.err(new m(k.PawnsOnBackrank)):f.ok(void 0):f.err(new m(k.Kings))}dropDests(t){return o.empty()}dests(t,r){if(r=r||this.ctx(),r.variantEnd)return o.empty();let s=this.board.get(t);if(!s||s.color!==this.turn)return o.empty();let n,i;if(s.role==="pawn"){n=K(this.turn,t).intersect(this.board[p(this.turn)]);let a=this.turn==="white"?8:-8,c=t+a;if(0<=c&&c<64&&!this.board.occupied.has(c)){n=n.with(c);let l=this.turn==="white"?t<16:t>=48,h=c+a;l&&!this.board.occupied.has(h)&&(n=n.with(h))}u(this.epSquare)&&Ie(this,t,r)&&(i=o.fromSquare(this.epSquare))}else s.role==="bishop"?n=L(t,this.board.occupied):s.role==="knight"?n=H(t):s.role==="rook"?n=U(t,this.board.occupied):s.role==="queen"?n=X(t,this.board.occupied):n=B(t);if(n=n.diff(this.board[this.turn]),u(r.king)){if(s.role==="king"){let a=this.board.occupied.without(t);for(let c of n)this.kingAttackers(c,p(this.turn),a).nonEmpty()&&(n=n.without(c));return n.union(ot(this,"a",r)).union(ot(this,"h",r))}if(r.checkers.nonEmpty()){let a=r.checkers.singleSquare();if(!u(a))return o.empty();n=n.intersect(V(a,r.king).with(a))}r.blockers.has(t)&&(n=n.intersect(Pt(t,r.king)))}return i&&(n=n.union(i)),n}isVariantEnd(){return!1}variantOutcome(t){}hasInsufficientMaterial(t){return this.board[t].intersect(this.board.pawn.union(this.board.rooksAndQueens())).nonEmpty()?!1:this.board[t].intersects(this.board.knight)?this.board[t].size()<=2&&this.board[p(t)].diff(this.board.king).diff(this.board.queen).isEmpty():this.board[t].intersects(this.board.bishop)?(!this.board.bishop.intersects(o.darkSquares())||!this.board.bishop.intersects(o.lightSquares()))&&this.board.pawn.isEmpty()&&this.board.knight.isEmpty():!0}toSetup(){var t,r;return{board:this.board.clone(),pockets:(t=this.pockets)===null||t===void 0?void 0:t.clone(),turn:this.turn,castlingRights:this.castles.castlingRights,epSquare:ze(this),remainingChecks:(r=this.remainingChecks)===null||r===void 0?void 0:r.clone(),halfmoves:Math.min(this.halfmoves,150),fullmoves:Math.min(Math.max(this.fullmoves,1),9999)}}isInsufficientMaterial(){return C.every(t=>this.hasInsufficientMaterial(t))}hasDests(t){t=t||this.ctx();for(let r of this.board[this.turn])if(this.dests(r,t).nonEmpty())return!0;return this.dropDests(t).nonEmpty()}isLegal(t,r){if(A(t))return!this.pockets||this.pockets[this.turn][t.role]<=0||t.role==="pawn"&&o.backranks().has(t.to)?!1:this.dropDests(r).has(t.to);{if(t.promotion==="pawn"||t.promotion==="king"&&this.rules!=="antichess"||!!t.promotion!==(this.board.pawn.has(t.from)&&o.backranks().has(t.to)))return!1;let s=this.dests(t.from,r);return s.has(t.to)||s.has(te(this,t).to)}}isCheck(){let t=this.board.kingOf(this.turn);return u(t)&&this.kingAttackers(t,p(this.turn),this.board.occupied).nonEmpty()}isEnd(t){return(t?t.variantEnd:this.isVariantEnd())?!0:this.isInsufficientMaterial()||!this.hasDests(t)}isCheckmate(t){return t=t||this.ctx(),!t.variantEnd&&t.checkers.nonEmpty()&&!this.hasDests(t)}isStalemate(t){return t=t||this.ctx(),!t.variantEnd&&t.checkers.isEmpty()&&!this.hasDests(t)}outcome(t){let r=this.variantOutcome(t);return r||(t=t||this.ctx(),this.isCheckmate(t)?{winner:p(this.turn)}:this.isInsufficientMaterial()||this.isStalemate(t)?{winner:void 0}:void 0)}allDests(t){t=t||this.ctx();let r=new Map;if(t.variantEnd)return r;for(let s of this.board[this.turn])r.set(s,this.dests(s,t));return r}play(t){let r=this.turn,s=this.epSquare,n=Bt(this,t);if(this.epSquare=void 0,this.halfmoves+=1,r==="black"&&(this.fullmoves+=1),this.turn=p(r),A(t))this.board.set(t.to,{role:t.role,color:r}),this.pockets&&this.pockets[r][t.role]--,t.role==="pawn"&&(this.halfmoves=0);else{let i=this.board.take(t.from);if(!i)return;let a;if(i.role==="pawn"){this.halfmoves=0,t.to===s&&(a=this.board.take(t.to+(r==="white"?-8:8)));let c=t.from-t.to;Math.abs(c)===16&&8<=t.from&&t.from<=55&&(this.epSquare=t.from+t.to>>1),t.promotion&&(i.role=t.promotion,i.promoted=!!this.pockets)}else if(i.role==="rook")this.castles.discardRook(t.from);else if(i.role==="king"){if(n){let c=this.castles.rook[r][n];if(u(c)){let l=this.board.take(c);this.board.set(J(r,n),i),l&&this.board.set(rt(r,n),l)}}this.castles.discardColor(r)}if(!n){let c=this.board.set(t.to,i)||a;c&&this.playCaptureAt(t.to,c)}}this.remainingChecks&&this.isCheck()&&(this.remainingChecks[r]=Math.max(this.remainingChecks[r]-1,0))}},Q=class extends O{constructor(){super("chess")}static default(){let t=new this;return t.reset(),t}static fromSetup(t){let r=new this;return r.setupUnchecked(t),r.validate().map(s=>r)}clone(){return super.clone()}},Be=(e,t)=>{if(!u(t))return;let r=e.turn==="white"?5:2,s=e.turn==="white"?8:-8;if(v(t)!==r||e.board.occupied.has(t+s))return;let n=t-s;if(!(!e.board.pawn.has(n)||!e.board[p(e.turn)].has(n)))return t},ze=e=>{if(!u(e.epSquare))return;let t=e.ctx(),s=e.board.pieces(e.turn,"pawn").intersect(K(p(e.turn),e.epSquare));for(let n of s)if(e.dests(n,t).has(e.epSquare))return e.epSquare},Ie=(e,t,r)=>{if(!u(e.epSquare)||!K(e.turn,t).has(e.epSquare))return!1;if(!u(r.king))return!0;let s=e.turn==="white"?8:-8,n=e.epSquare-s;return e.kingAttackers(r.king,p(e.turn),e.board.occupied.toggle(t).toggle(n).with(e.epSquare)).without(n).isEmpty()},ot=(e,t,r)=>{if(!u(r.king)||r.checkers.nonEmpty())return o.empty();let s=e.castles.rook[e.turn][t];if(!u(s))return o.empty();if(e.castles.path[e.turn][t].intersects(e.board.occupied))return o.empty();let n=J(e.turn,t),i=V(r.king,n),a=e.board.occupied.without(r.king);for(let h of i)if(e.kingAttackers(h,p(e.turn),a).nonEmpty())return o.empty();let c=rt(e.turn,t),l=e.board.occupied.toggle(r.king).toggle(s).toggle(c);return e.kingAttackers(n,p(e.turn),l).nonEmpty()?o.empty():o.fromSquare(s)},at=(e,t,r)=>{if(r.variantEnd)return o.empty();let s=e.board.get(t);if(!s||s.color!==e.turn)return o.empty();let n=it(s,t,e.board.occupied);if(s.role==="pawn"){let i=e.board[p(e.turn)];u(e.epSquare)&&(i=i.with(e.epSquare)),n=n.intersect(i);let a=e.turn==="white"?8:-8,c=t+a;if(0<=c&&c<64&&!e.board.occupied.has(c)){n=n.with(c);let l=e.turn==="white"?t<16:t>=48,h=c+a;l&&!e.board.occupied.has(h)&&(n=n.with(h))}return n}else n=n.diff(e.board[e.turn]);return t===r.king?n.union(ot(e,"a",r)).union(ot(e,"h",r)):n};var Bt=(e,t)=>{if(A(t))return;let r=t.to-t.from;if(!(Math.abs(r)!==2&&!e.board[e.turn].has(t.to))&&e.board.king.has(t.from))return r>0?"h":"a"},te=(e,t)=>{let r=Bt(e,t);if(!r)return t;let s=e.castles.rook[e.turn][r];return{from:t.from,to:u(s)?s:t.to}};var zt={};tt(zt,{makeSan:()=>_e,makeSanAndPlay:()=>re,makeSanVariation:()=>Te,parseSan:()=>De});var ee=(e,t)=>{let r="";if(A(t))t.role!=="pawn"&&(r=P(t.role).toUpperCase()),r+="@"+y(t.to);else{let s=e.board.getRole(t.from);if(!s)return"--";if(s==="king"&&(e.board[e.turn].has(t.to)||Math.abs(t.to-t.from)===2))r=t.to>t.from?"O-O":"O-O-O";else{let n=e.board.occupied.has(t.to)||s==="pawn"&&g(t.from)!==g(t.to);if(s!=="pawn"){r=P(s).toUpperCase();let i;if(s==="king"?i=B(t.to).intersect(e.board.king):s==="queen"?i=X(t.to,e.board.occupied).intersect(e.board.queen):s==="rook"?i=U(t.to,e.board.occupied).intersect(e.board.rook):s==="bishop"?i=L(t.to,e.board.occupied).intersect(e.board.bishop):i=H(t.to).intersect(e.board.knight),i=i.intersect(e.board[e.turn]).without(t.from),i.nonEmpty()){let a=e.ctx();for(let c of i)e.dests(c,a).has(t.to)||(i=i.without(c));if(i.nonEmpty()){let c=!1,l=i.intersects(o.fromRank(v(t.from)));i.intersects(o.fromFile(g(t.from)))?c=!0:l=!0,l&&(r+=D[g(t.from)]),c&&(r+=Z[v(t.from)])}}}else n&&(r=D[g(t.from)]);n&&(r+="x"),r+=y(t.to),t.promotion&&(r+="="+P(t.promotion).toUpperCase())}}return r},re=(e,t)=>{var r;let s=ee(e,t);return e.play(t),!((r=e.outcome())===null||r===void 0)&&r.winner?s+"#":e.isCheck()?s+"+":s},Te=(e,t)=>{var r;e=e.clone();let s=[];for(let n=0;n<t.length;n++){n!==0&&s.push(" "),e.turn==="white"?s.push(e.fullmoves,". "):n===0&&s.push(e.fullmoves,"... ");let i=ee(e,t[n]);if(e.play(t[n]),s.push(i),i==="--")return s.join("");n===t.length-1&&(!((r=e.outcome())===null||r===void 0)&&r.winner)?s.push("#"):e.isCheck()&&s.push("+")}return s.join("")},_e=(e,t)=>re(e.clone(),t),De=(e,t)=>{let r=e.ctx(),s=t.match(/^([NBRQK])?([a-h])?([1-8])?[-x]?([a-h][1-8])(?:=?([nbrqkNBRQK]))?[+#]?$/);if(!s){let d;if(t==="O-O"||t==="O-O+"||t==="O-O#"?d="h":(t==="O-O-O"||t==="O-O-O+"||t==="O-O-O#")&&(d="a"),d){let w=e.castles.rook[e.turn][d];return!u(r.king)||!u(w)||!e.dests(r.king,r).has(w)?void 0:{from:r.king,to:w}}let b=t.match(/^([pnbrqkPNBRQK])?@([a-h][1-8])[+#]?$/);if(!b)return;let E={role:b[1]?I(b[1]):"pawn",to:q(b[2])};return e.isLegal(E,r)?E:void 0}let n=s[1]?I(s[1]):"pawn",i=q(s[4]),a=s[5]?I(s[5]):void 0;if(!!a!==(n==="pawn"&&o.backranks().has(i))||a==="king"&&e.rules!=="antichess")return;let c=e.board.pieces(e.turn,n);n==="pawn"&&!s[2]?c=c.intersect(o.fromFile(g(i))):s[2]&&(c=c.intersect(o.fromFile(s[2].charCodeAt(0)-97))),s[3]&&(c=c.intersect(o.fromRank(s[3].charCodeAt(0)-49)));let l=n==="pawn"?o.fromFile(g(i)):o.empty();c=c.intersect(l.union(it({color:p(e.turn),role:n},i,e.board.occupied)));let h;for(let d of c)if(e.dests(d,r).has(i)){if(u(h))return;h=d}if(u(h))return{from:h,to:i,promotion:a}};var Qt={};tt(Qt,{Box:()=>Gt,ChildNode:()=>$,Node:()=>W,PgnError:()=>bt,PgnParser:()=>xt,defaultGame:()=>we,defaultHeaders:()=>St,emptyHeaders:()=>Je,extend:()=>Qe,isChildNode:()=>He,isMate:()=>xe,isPawns:()=>rr,makeComment:()=>or,makeOutcome:()=>$t,makePgn:()=>Ze,makeVariant:()=>be,parseComment:()=>ar,parseOutcome:()=>Ht,parsePgn:()=>Xe,parseVariant:()=>ge,setStartingPosition:()=>er,startingPosition:()=>tr,transform:()=>je,walk:()=>We});var Ft={};tt(Ft,{EMPTY_BOARD_FEN:()=>ie,EMPTY_EPD:()=>oe,EMPTY_FEN:()=>Le,FenError:()=>S,INITIAL_BOARD_FEN:()=>se,INITIAL_EPD:()=>ne,INITIAL_FEN:()=>Ke,InvalidFen:()=>x,makeBoardFen:()=>ce,makeCastlingFen:()=>ue,makeFen:()=>lt,makePiece:()=>ut,makePocket:()=>_t,makePockets:()=>he,makeRemainingChecks:()=>le,parseBoardFen:()=>ct,parseCastlingFen:()=>ae,parseFen:()=>ht,parsePiece:()=>Ve,parsePockets:()=>It,parseRemainingChecks:()=>Tt});var z=class e{constructor(){}static empty(){let t=new e;for(let r of R)t[r]=0;return t}static fromBoard(t,r){let s=new e;for(let n of R)s[n]=t.pieces(r,n).size();return s}clone(){let t=new e;for(let r of R)t[r]=this[r];return t}equals(t){return R.every(r=>this[r]===t[r])}add(t){let r=new e;for(let s of R)r[s]=this[s]+t[s];return r}subtract(t){let r=new e;for(let s of R)r[s]=this[s]-t[s];return r}nonEmpty(){return R.some(t=>this[t]>0)}isEmpty(){return!this.nonEmpty()}hasPawns(){return this.pawn>0}hasNonPawns(){return this.knight>0||this.bishop>0||this.rook>0||this.queen>0||this.king>0}size(){return this.pawn+this.knight+this.bishop+this.rook+this.queen+this.king}},G=class e{constructor(t,r){this.white=t,this.black=r}static empty(){return new e(z.empty(),z.empty())}static fromBoard(t){return new e(z.fromBoard(t,"white"),z.fromBoard(t,"black"))}clone(){return new e(this.white.clone(),this.black.clone())}equals(t){return this.white.equals(t.white)&&this.black.equals(t.black)}add(t){return new e(this.white.add(t.white),this.black.add(t.black))}subtract(t){return new e(this.white.subtract(t.white),this.black.subtract(t.black))}count(t){return this.white[t]+this.black[t]}size(){return this.white.size()+this.black.size()}isEmpty(){return this.white.isEmpty()&&this.black.isEmpty()}nonEmpty(){return!this.isEmpty()}hasPawns(){return this.white.hasPawns()||this.black.hasPawns()}hasNonPawns(){return this.white.hasNonPawns()||this.black.hasNonPawns()}},T=class e{constructor(t,r){this.white=t,this.black=r}static default(){return new e(3,3)}clone(){return new e(this.white,this.black)}equals(t){return this.white===t.white&&this.black===t.black}},Fe=()=>({board:M.default(),pockets:void 0,turn:"white",castlingRights:o.corners(),epSquare:void 0,remainingChecks:void 0,halfmoves:0,fullmoves:1});var se="rnbqkbnr/pppppppp/8/8/8/8/PPPPPPPP/RNBQKBNR",ne=se+" w KQkq -",Ke=ne+" 0 1",ie="8/8/8/8/8/8/8/8",oe=ie+" w - -",Le=oe+" 0 1",x;(function(e){e.Fen="ERR_FEN",e.Board="ERR_BOARD",e.Pockets="ERR_POCKETS",e.Turn="ERR_TURN",e.Castling="ERR_CASTLING",e.EpSquare="ERR_EP_SQUARE",e.RemainingChecks="ERR_REMAINING_CHECKS",e.Halfmoves="ERR_HALFMOVES",e.Fullmoves="ERR_FULLMOVES"})(x||(x={}));var S=class extends Error{},Ue=(e,t,r)=>{let s=e.indexOf(t);for(;r-- >0&&s!==-1;)s=e.indexOf(t,s+t.length);return s},j=e=>/^\d{1,4}$/.test(e)?parseInt(e,10):void 0,Dt=e=>{let t=I(e);return t&&{role:t,color:e.toLowerCase()===e?"black":"white"}},ct=e=>{let t=M.empty(),r=7,s=0;for(let n=0;n<e.length;n++){let i=e[n];if(i==="/"&&s===8)s=0,r--;else{let a=parseInt(i,10);if(a>0)s+=a;else{if(s>=8||r<0)return f.err(new S(x.Board));let c=s+r*8,l=Dt(i);if(!l)return f.err(new S(x.Board));e[n+1]==="~"&&(l.promoted=!0,n++),t.set(c,l),s++}}}return r!==0||s!==8?f.err(new S(x.Board)):f.ok(t)},It=e=>{if(e.length>64)return f.err(new S(x.Pockets));let t=G.empty();for(let r of e){let s=Dt(r);if(!s)return f.err(new S(x.Pockets));t[s.color][s.role]++}return f.ok(t)},ae=(e,t)=>{let r=o.empty();if(t==="-")return f.ok(r);for(let s of t){let n=s.toLowerCase(),i=s===n?"black":"white",a=i==="white"?0:7;if("a"<=n&&n<="h")r=r.with(et(n.charCodeAt(0)-97,a));else if(n==="k"||n==="q"){let c=e[i].intersect(o.backrank(i)).intersect(e.rook.union(e.king)),l=n==="k"?c.last():c.first();r=r.with(u(l)&&e.rook.has(l)?l:et(n==="k"?7:0,a))}else return f.err(new S(x.Castling))}return C.some(s=>o.backrank(s).intersect(r).size()>2)?f.err(new S(x.Castling)):f.ok(r)},Tt=e=>{let t=e.split("+");if(t.length===3&&t[0]===""){let r=j(t[1]),s=j(t[2]);return!u(r)||r>3||!u(s)||s>3?f.err(new S(x.RemainingChecks)):f.ok(new T(3-r,3-s))}else if(t.length===2){let r=j(t[0]),s=j(t[1]);return!u(r)||r>3||!u(s)||s>3?f.err(new S(x.RemainingChecks)):f.ok(new T(r,s))}else return f.err(new S(x.RemainingChecks))},ht=e=>{let t=e.split(/[\s_]+/),r=t.shift(),s,n=f.ok(void 0);if(r.endsWith("]")){let c=r.indexOf("[");if(c===-1)return f.err(new S(x.Fen));s=ct(r.slice(0,c)),n=It(r.slice(c+1,-1))}else{let c=Ue(r,"/",7);c===-1?s=ct(r):(s=ct(r.slice(0,c)),n=It(r.slice(c+1)))}let i,a=t.shift();if(!u(a)||a==="w")i="white";else if(a==="b")i="black";else return f.err(new S(x.Turn));return s.chain(c=>{let l=t.shift(),h=u(l)?ae(c,l):f.ok(o.empty()),d=t.shift(),b;if(u(d)&&d!=="-"&&(b=q(d),!u(b)))return f.err(new S(x.EpSquare));let E=t.shift(),w;u(E)&&E.includes("+")&&(w=Tt(E),E=t.shift());let _=u(E)?j(E):0;if(!u(_))return f.err(new S(x.Halfmoves));let Y=t.shift(),Wt=u(Y)?j(Y):1;if(!u(Wt))return f.err(new S(x.Fullmoves));let Yt=t.shift(),yt=f.ok(void 0);if(u(Yt)){if(u(w))return f.err(new S(x.RemainingChecks));yt=Tt(Yt)}else u(w)&&(yt=w);return t.length>0?f.err(new S(x.Fen)):n.chain(Se=>h.chain(ye=>yt.map(Ee=>({board:c,pockets:Se,turn:i,castlingRights:ye,remainingChecks:Ee,epSquare:b,halfmoves:_,fullmoves:Math.max(1,Wt)}))))})},Ve=e=>{if(!e)return;let t=Dt(e[0]);if(t){if(e.length===2&&e[1]==="~")t.promoted=!0;else if(e.length>1)return;return t}},ut=e=>{let t=P(e.role);return e.color==="white"&&(t=t.toUpperCase()),e.promoted&&(t+="~"),t},ce=e=>{let t="",r=0;for(let s=7;s>=0;s--)for(let n=0;n<8;n++){let i=n+s*8,a=e.get(i);a?(r>0&&(t+=r,r=0),t+=ut(a)):r++,n===7&&(r>0&&(t+=r,r=0),s!==0&&(t+="/"))}return t},_t=e=>R.map(t=>P(t).repeat(e[t])).join(""),he=e=>_t(e.white).toUpperCase()+_t(e.black),ue=(e,t)=>{let r="";for(let s of C){let n=o.backrank(s),i=e.kingOf(s);u(i)&&!n.has(i)&&(i=void 0);let a=e.pieces(s,"rook").intersect(n);for(let c of t.intersect(n).reversed())if(c===a.first()&&u(i)&&c<i)r+=s==="white"?"Q":"q";else if(c===a.last()&&u(i)&&i<c)r+=s==="white"?"K":"k";else{let l=D[g(c)];r+=s==="white"?l.toUpperCase():l}}return r||"-"},le=e=>`${e.white}+${e.black}`,lt=(e,t)=>[ce(e.board)+(e.pockets?`[${he(e.pockets)}]`:""),e.turn[0],ue(e.board,e.castlingRights),u(e.epSquare)?y(e.epSquare):"-",...e.remainingChecks?[le(e.remainingChecks)]:[],...t!=null&&t.epd?[]:[Math.max(0,Math.min(e.halfmoves,9999)),Math.max(1,Math.min(e.fullmoves,9999))]].join(" ");var ft=class extends O{constructor(){super("crazyhouse")}reset(){super.reset(),this.pockets=G.empty()}setupUnchecked(t){super.setupUnchecked(t),this.board.promoted=t.board.promoted.intersect(t.board.occupied).diff(t.board.king).diff(t.board.pawn),this.pockets=t.pockets?t.pockets.clone():G.empty()}static default(){let t=new this;return t.reset(),t}static fromSetup(t){let r=new this;return r.setupUnchecked(t),r.validate().map(s=>r)}clone(){return super.clone()}validate(){return super.validate().chain(t=>{var r,s;return!((r=this.pockets)===null||r===void 0)&&r.count("king")?f.err(new m(k.Kings)):(((s=this.pockets)===null||s===void 0?void 0:s.size())||0)+this.board.occupied.size()>64?f.err(new m(k.Variant)):f.ok(void 0)})}hasInsufficientMaterial(t){return this.pockets?this.board.occupied.size()+this.pockets.size()<=3&&this.board.pawn.isEmpty()&&this.board.promoted.isEmpty()&&this.board.rooksAndQueens().isEmpty()&&this.pockets.count("pawn")<=0&&this.pockets.count("rook")<=0&&this.pockets.count("queen")<=0:super.hasInsufficientMaterial(t)}dropDests(t){var r,s;let n=this.board.occupied.complement().intersect(!((r=this.pockets)===null||r===void 0)&&r[this.turn].hasNonPawns()?o.full():!((s=this.pockets)===null||s===void 0)&&s[this.turn].hasPawns()?o.backranks().complement():o.empty());if(t=t||this.ctx(),u(t.king)&&t.checkers.nonEmpty()){let i=t.checkers.singleSquare();return u(i)?n.intersect(V(i,t.king)):o.empty()}else return n}},dt=class extends O{constructor(){super("atomic")}static default(){let t=new this;return t.reset(),t}static fromSetup(t){let r=new this;return r.setupUnchecked(t),r.validate().map(s=>r)}clone(){return super.clone()}validate(){if(this.board.occupied.isEmpty())return f.err(new m(k.Empty));if(this.board.king.size()>2)return f.err(new m(k.Kings));let t=this.board.kingOf(p(this.turn));return u(t)?this.kingAttackers(t,this.turn,this.board.occupied).nonEmpty()?f.err(new m(k.OppositeCheck)):o.backranks().intersects(this.board.pawn)?f.err(new m(k.PawnsOnBackrank)):f.ok(void 0):f.err(new m(k.Kings))}kingAttackers(t,r,s){let n=this.board.pieces(r,"king");return n.isEmpty()||B(t).intersects(n)?o.empty():super.kingAttackers(t,r,s)}playCaptureAt(t,r){super.playCaptureAt(t,r),this.board.take(t);for(let s of B(t).intersect(this.board.occupied).diff(this.board.pawn)){let n=this.board.take(s);(n==null?void 0:n.role)==="rook"&&this.castles.discardRook(s),(n==null?void 0:n.role)==="king"&&this.castles.discardColor(n.color)}}hasInsufficientMaterial(t){if(this.board.pieces(p(t),"king").isEmpty())return!1;if(this.board[t].diff(this.board.king).isEmpty())return!0;if(this.board[p(t)].diff(this.board.king).nonEmpty()){if(this.board.occupied.equals(this.board.bishop.union(this.board.king))){if(!this.board.bishop.intersect(this.board.white).intersects(o.darkSquares()))return!this.board.bishop.intersect(this.board.black).intersects(o.lightSquares());if(!this.board.bishop.intersect(this.board.white).intersects(o.lightSquares()))return!this.board.bishop.intersect(this.board.black).intersects(o.darkSquares())}return!1}return this.board.queen.nonEmpty()||this.board.pawn.nonEmpty()?!1:this.board.knight.union(this.board.bishop).union(this.board.rook).size()===1?!0:this.board.occupied.equals(this.board.knight.union(this.board.king))?this.board.knight.size()<=2:!1}dests(t,r){r=r||this.ctx();let s=o.empty();for(let n of at(this,t,r)){let i=this.clone();i.play({from:t,to:n});let a=i.board.kingOf(this.turn);u(a)&&(!u(i.board.kingOf(i.turn))||i.kingAttackers(a,i.turn,i.board.occupied).isEmpty())&&(s=s.with(n))}return s}isVariantEnd(){return!!this.variantOutcome()}variantOutcome(t){for(let r of C)if(this.board.pieces(r,"king").isEmpty())return{winner:p(r)}}},pt=class extends O{constructor(){super("antichess")}reset(){super.reset(),this.castles=N.empty()}setupUnchecked(t){super.setupUnchecked(t),this.castles=N.empty()}static default(){let t=new this;return t.reset(),t}static fromSetup(t){let r=new this;return r.setupUnchecked(t),r.validate().map(s=>r)}clone(){return super.clone()}validate(){return this.board.occupied.isEmpty()?f.err(new m(k.Empty)):o.backranks().intersects(this.board.pawn)?f.err(new m(k.PawnsOnBackrank)):f.ok(void 0)}kingAttackers(t,r,s){return o.empty()}ctx(){let t=super.ctx();if(u(this.epSquare)&&K(p(this.turn),this.epSquare).intersects(this.board.pieces(this.turn,"pawn")))return t.mustCapture=!0,t;let r=this.board[p(this.turn)];for(let s of this.board[this.turn])if(at(this,s,t).intersects(r))return t.mustCapture=!0,t;return t}dests(t,r){r=r||this.ctx();let s=at(this,t,r),n=this.board[p(this.turn)];return s.intersect(r.mustCapture?u(this.epSquare)&&this.board.getRole(t)==="pawn"?n.with(this.epSquare):n:o.full())}hasInsufficientMaterial(t){if(this.board[t].isEmpty())return!1;if(this.board[p(t)].isEmpty())return!0;if(this.board.occupied.equals(this.board.bishop)){let r=this.board[t].intersects(o.lightSquares()),s=this.board[t].intersects(o.darkSquares()),n=this.board[p(t)].isDisjoint(o.lightSquares()),i=this.board[p(t)].isDisjoint(o.darkSquares());return r&&n||s&&i}return this.board.occupied.equals(this.board.knight)&&this.board.occupied.size()===2?this.board.white.intersects(o.lightSquares())!==this.board.black.intersects(o.darkSquares())!=(this.turn===t):!1}isVariantEnd(){return this.board[this.turn].isEmpty()}variantOutcome(t){if(t=t||this.ctx(),t.variantEnd||this.isStalemate(t))return{winner:this.turn}}},kt=class extends O{constructor(){super("kingofthehill")}static default(){let t=new this;return t.reset(),t}static fromSetup(t){let r=new this;return r.setupUnchecked(t),r.validate().map(s=>r)}clone(){return super.clone()}hasInsufficientMaterial(t){return!1}isVariantEnd(){return this.board.king.intersects(o.center())}variantOutcome(t){for(let r of C)if(this.board.pieces(r,"king").intersects(o.center()))return{winner:r}}},mt=class extends O{constructor(){super("3check")}reset(){super.reset(),this.remainingChecks=T.default()}setupUnchecked(t){var r;super.setupUnchecked(t),this.remainingChecks=((r=t.remainingChecks)===null||r===void 0?void 0:r.clone())||T.default()}static default(){let t=new this;return t.reset(),t}static fromSetup(t){let r=new this;return r.setupUnchecked(t),r.validate().map(s=>r)}clone(){return super.clone()}hasInsufficientMaterial(t){return this.board.pieces(t,"king").equals(this.board[t])}isVariantEnd(){return!!this.remainingChecks&&(this.remainingChecks.white<=0||this.remainingChecks.black<=0)}variantOutcome(t){if(this.remainingChecks){for(let r of C)if(this.remainingChecks[r]<=0)return{winner:r}}}},Ge=()=>{let e=M.empty();return e.occupied=new o(65535,0),e.promoted=o.empty(),e.white=new o(61680,0),e.black=new o(3855,0),e.pawn=o.empty(),e.knight=new o(6168,0),e.bishop=new o(9252,0),e.rook=new o(16962,0),e.queen=new o(129,0),e.king=new o(33024,0),e},wt=class extends O{constructor(){super("racingkings")}reset(){this.board=Ge(),this.pockets=void 0,this.turn="white",this.castles=N.empty(),this.epSquare=void 0,this.remainingChecks=void 0,this.halfmoves=0,this.fullmoves=1}setupUnchecked(t){super.setupUnchecked(t),this.castles=N.empty()}static default(){let t=new this;return t.reset(),t}static fromSetup(t){let r=new this;return r.setupUnchecked(t),r.validate().map(s=>r)}clone(){return super.clone()}validate(){return this.isCheck()||this.board.pawn.nonEmpty()?f.err(new m(k.Variant)):super.validate()}dests(t,r){if(r=r||this.ctx(),t===r.king)return super.dests(t,r);let s=o.empty();for(let n of super.dests(t,r)){let i={from:t,to:n},a=this.clone();a.play(i),a.isCheck()||(s=s.with(n))}return s}hasInsufficientMaterial(t){return!1}isVariantEnd(){let t=o.fromRank(7),r=this.board.king.intersect(t);if(r.isEmpty())return!1;if(this.turn==="white"||r.intersects(this.board.black))return!0;let s=this.board.kingOf("black");if(u(s)){let n=this.board.occupied.without(s);for(let i of B(s).intersect(t).diff(this.board.black))if(this.kingAttackers(i,"white",n).isEmpty())return!1}return!0}variantOutcome(t){if(t?!t.variantEnd:!this.isVariantEnd())return;let r=o.fromRank(7),s=this.board.pieces("black","king").intersects(r),n=this.board.pieces("white","king").intersects(r);return s&&!n?{winner:"black"}:n&&!s?{winner:"white"}:{winner:void 0}}},$e=()=>{let e=M.empty();return e.occupied=new o(4294967295,4294901862),e.promoted=o.empty(),e.white=new o(4294967295,102),e.black=new o(0,4294901760),e.pawn=new o(4294967295,16711782),e.knight=new o(0,1107296256),e.bishop=new o(0,603979776),e.rook=new o(0,2164260864),e.queen=new o(0,134217728),e.king=new o(0,268435456),e},gt=class extends O{constructor(){super("horde")}reset(){this.board=$e(),this.pockets=void 0,this.turn="white",this.castles=N.default(),this.castles.discardColor("white"),this.epSquare=void 0,this.remainingChecks=void 0,this.halfmoves=0,this.fullmoves=1}static default(){let t=new this;return t.reset(),t}static fromSetup(t){let r=new this;return r.setupUnchecked(t),r.validate().map(s=>r)}clone(){return super.clone()}validate(){if(this.board.occupied.isEmpty())return f.err(new m(k.Empty));if(this.board.king.size()!==1)return f.err(new m(k.Kings));let t=this.board.kingOf(p(this.turn));if(u(t)&&this.kingAttackers(t,this.turn,this.board.occupied).nonEmpty())return f.err(new m(k.OppositeCheck));for(let r of C){let s=this.board.pieces(r,"king").isEmpty()?o.backrank(p(r)):o.backranks();if(this.board.pieces(r,"pawn").intersects(s))return f.err(new m(k.PawnsOnBackrank))}return f.ok(void 0)}hasInsufficientMaterial(t){if(this.board.pieces(t,"king").nonEmpty())return!1;let r=w=>w==="light"?"dark":"light",s=w=>w==="light"?o.lightSquares():o.darkSquares(),n=w=>{let _=this.board.pieces(w,"bishop");return _.intersects(o.darkSquares())&&_.intersects(o.lightSquares())},i=z.fromBoard(this.board,t),a=w=>s(w).intersect(this.board.pieces(t,"bishop")).size(),c=a("light")>=1?"light":"dark",l=i.pawn+i.knight+i.rook+i.queen+Math.min(a("dark"),2)+Math.min(a("light"),2),h=z.fromBoard(this.board,p(t)),d=w=>s(w).intersect(this.board.pieces(p(t),"bishop")).size(),b=h.size(),E=w=>b-w;if(l===0)return!0;if(l>=4||(i.pawn>=1||i.queen>=1)&&l>=2||i.rook>=1&&l>=2&&!(l===2&&i.rook===1&&i.bishop===1&&E(d(c))===1))return!1;if(l===1){if(b===1)return!0;if(i.queen===1)return!(h.pawn>=1||h.rook>=1||d("light")>=2||d("dark")>=2);if(i.pawn===1){let w=this.board.pieces(t,"pawn").last(),_=this.clone();_.board.set(w,{color:t,role:"queen"});let Y=this.clone();return Y.board.set(w,{color:t,role:"knight"}),_.hasInsufficientMaterial(t)&&Y.hasInsufficientMaterial(t)}else{if(i.rook===1)return!(h.pawn>=2||h.rook>=1&&h.pawn>=1||h.rook>=1&&h.knight>=1||h.pawn>=1&&h.knight>=1);if(i.bishop===1)return!(d(r(c))>=2||d(r(c))>=1&&h.pawn>=1||h.pawn>=2);if(i.knight===1)return!(b>=4&&(h.knight>=2||h.pawn>=2||h.rook>=1&&h.knight>=1||h.rook>=1&&h.bishop>=1||h.knight>=1&&h.bishop>=1||h.rook>=1&&h.pawn>=1||h.knight>=1&&h.pawn>=1||h.bishop>=1&&h.pawn>=1||n(p(t))&&h.pawn>=1)&&(d("dark")<2||E(d("dark"))>=3)&&(d("light")<2||E(d("light"))>=3))}}else{if(l===2)return b===1?!0:i.knight===2?h.pawn+h.bishop+h.knight<1:n(t)?!(h.pawn>=1||h.bishop>=1||h.knight>=1&&h.rook+h.queen>=1):i.bishop>=1&&i.knight>=1?!(h.pawn>=1||d(r(c))>=1||E(d(c))>=3):!(h.pawn>=1&&d(r(c))>=1||h.pawn>=1&&h.knight>=1||d(r(c))>=1&&h.knight>=1||d(r(c))>=2||h.knight>=2||h.pawn>=2);if(l===3)return i.knight===2&&i.bishop===1||i.knight===3||n(t)?!1:b===1}return!0}isVariantEnd(){return this.board.white.isEmpty()||this.board.black.isEmpty()}variantOutcome(t){if(this.board.white.isEmpty())return{winner:"black"};if(this.board.black.isEmpty())return{winner:"white"}}},Kt=e=>{switch(e){case"chess":return Q.default();case"antichess":return pt.default();case"atomic":return dt.default();case"horde":return gt.default();case"racingkings":return wt.default();case"kingofthehill":return kt.default();case"3check":return mt.default();case"crazyhouse":return ft.default()}},fe=(e,t)=>{switch(e){case"chess":return Q.fromSetup(t);case"antichess":return pt.fromSetup(t);case"atomic":return dt.fromSetup(t);case"horde":return gt.fromSetup(t);case"racingkings":return wt.fromSetup(t);case"kingofthehill":return kt.fromSetup(t);case"3check":return mt.fromSetup(t);case"crazyhouse":return ft.fromSetup(t)}};var we=(e=St)=>({headers:e(),moves:new W}),W=class{constructor(){this.children=[]}*mainlineNodes(){let t=this;for(;t.children.length;){let r=t.children[0];yield r,t=r}}*mainline(){for(let t of this.mainlineNodes())yield t.data}end(){let t=this;for(;t.children.length;)t=t.children[0];return t}},$=class extends W{constructor(t){super(),this.data=t}},He=e=>e instanceof $,Qe=(e,t)=>{for(let r of t){let s=new $(r);e.children.push(s),e=s}return e},Gt=class e{constructor(t){this.value=t}clone(){return new e(this.value)}},je=(e,t,r)=>{let s=new W,n=[{before:e,after:s,ctx:t}],i;for(;i=n.pop();)for(let a=0;a<i.before.children.length;a++){let c=a<i.before.children.length-1?i.ctx.clone():i.ctx,l=i.before.children[a],h=r(c,l.data,a);if(u(h)){let d=new $(h);i.after.children.push(d),n.push({before:l,after:d,ctx:c})}}return s},We=(e,t,r)=>{let s=[{node:e,ctx:t}],n;for(;n=s.pop();)for(let i=0;i<n.node.children.length;i++){let a=i<n.node.children.length-1?n.ctx.clone():n.ctx,c=n.node.children[i];r(a,c.data,i)!==!1&&s.push({node:c,ctx:a})}},$t=e=>e?e.winner==="white"?"1-0":e.winner==="black"?"0-1":"1/2-1/2":"*",Ht=e=>e==="1-0"||e==="1\u20130"||e==="1\u20140"?{winner:"white"}:e==="0-1"||e==="0\u20131"||e==="0\u20141"?{winner:"black"}:e==="1/2-1/2"||e==="1/2\u20131/2"||e==="1/2\u20141/2"?{winner:void 0}:void 0,Ye=e=>e.replace(/\\/g,"\\\\").replace(/"/g,'\\"'),Lt=e=>e.replace(/\}/g,""),Ze=e=>{let t=[],r=[];if(e.headers.size){for(let[h,d]of e.headers.entries())t.push("[",h,' "',Ye(d),`"]
`);t.push(`
`)}for(let h of e.comments||[])r.push("{",Lt(h),"}");let s=e.headers.get("FEN"),n=s?ht(s).unwrap(h=>(h.fullmoves-1)*2+(h.turn==="white"?0:1),h=>0):0,i=[],a=e.moves.children[Symbol.iterator](),c=a.next();c.done||i.push({state:0,ply:n,node:c.value,sidelines:a,startsVariation:!1,inVariation:!1});let l=!0;for(;i.length;){let h=i[i.length-1];switch(h.inVariation&&(r.push(")"),h.inVariation=!1,l=!0),h.state){case 0:for(let d of h.node.data.startingComments||[])r.push("{",Lt(d),"}"),l=!0;(l||h.ply%2===0)&&(r.push(Math.floor(h.ply/2)+1+(h.ply%2?"...":".")),l=!1),r.push(h.node.data.san);for(let d of h.node.data.nags||[])r.push("$"+d),l=!0;for(let d of h.node.data.comments||[])r.push("{",Lt(d),"}");h.state=1;case 1:{let d=h.sidelines.next();if(d.done){let b=h.node.children[Symbol.iterator](),E=b.next();E.done||i.push({state:0,ply:h.ply+1,node:E.value,sidelines:b,startsVariation:!1,inVariation:!1}),h.state=2}else r.push("("),l=!0,i.push({state:0,ply:h.ply,node:d.value,sidelines:[][Symbol.iterator](),startsVariation:!0,inVariation:!1}),h.inVariation=!0;break}case 2:i.pop()}}return r.push($t(Ht(e.headers.get("Result")))),t.push(r.join(" "),`
`),t.join("")},St=()=>new Map([["Event","?"],["Site","?"],["Date","????.??.??"],["Round","?"],["White","?"],["Black","?"],["Result","*"]]),Je=()=>new Map,de="\uFEFF",Ut=e=>/^\s*$/.test(e),Vt=e=>e.startsWith("%"),bt=class extends Error{},xt=class{constructor(t,r=St,s=1e6){this.emitGame=t,this.initHeaders=r,this.maxBudget=s,this.lineBuf=[],this.resetGame(),this.state=0}resetGame(){this.budget=this.maxBudget,this.found=!1,this.state=1,this.game=we(this.initHeaders),this.stack=[{parent:this.game.moves,root:!0}],this.commentBuf=[]}consumeBudget(t){if(this.budget-=t,this.budget<0)throw new bt("ERR_PGN_BUDGET")}parse(t,r){if(!(this.budget<0))try{let s=0;for(;;){let n=t.indexOf(`
`,s);if(n===-1)break;let i=n>s&&t[n-1]==="\r"?n-1:n;this.consumeBudget(n-s),this.lineBuf.push(t.slice(s,i)),s=n+1,this.handleLine()}this.consumeBudget(t.length-s),this.lineBuf.push(t.slice(s)),r!=null&&r.stream||(this.handleLine(),this.emit(void 0))}catch(s){this.emit(s)}}handleLine(){let t=!0,r=this.lineBuf.join("");this.lineBuf=[];t:for(;;)switch(this.state){case 0:r.startsWith(de)&&(r=r.slice(de.length)),this.state=1;case 1:if(Ut(r)||Vt(r))return;this.found=!0,this.state=2;case 2:{if(Vt(r))return;let s=!0;for(;s;)s=!1,r=r.replace(/^\s*\[([A-Za-z0-9][A-Za-z0-9_+#=:-]*)\s+"((?:[^"\\]|\\"|\\\\)*)"\]/,(n,i,a)=>(this.consumeBudget(200),this.handleHeader(i,a.replace(/\\"/g,'"').replace(/\\\\/g,"\\")),s=!0,t=!1,""));if(Ut(r))return;this.state=3}case 3:{if(t){if(Vt(r))return;if(Ut(r))return this.emit(void 0)}let s=/(?:[NBKRQ]?[a-h]?[1-8]?[-x]?[a-h][1-8](?:=?[nbrqkNBRQK])?|[pnbrqkPNBRQK]?@[a-h][1-8]|[O0o][-–—][O0o](?:[-–—][O0o])?)[+#]?|--|Z0|0000|@@@@|{|;|\$\d{1,4}|[?!]{1,2}|\(|\)|\*|1[-–—]0|0[-–—]1|1\/2[-–—]1\/2/g,n;for(;n=s.exec(r);){let i=this.stack[this.stack.length-1],a=n[0];if(a===";")return;if(a.startsWith("$"))this.handleNag(parseInt(a.slice(1),10));else if(a==="!")this.handleNag(1);else if(a==="?")this.handleNag(2);else if(a==="!!")this.handleNag(3);else if(a==="??")this.handleNag(4);else if(a==="!?")this.handleNag(5);else if(a==="?!")this.handleNag(6);else if(a==="1-0"||a==="1\u20130"||a==="1\u20140"||a==="0-1"||a==="0\u20131"||a==="0\u20141"||a==="1/2-1/2"||a==="1/2\u20131/2"||a==="1/2\u20141/2"||a==="*")this.stack.length===1&&a!=="*"&&this.handleHeader("Result",a);else if(a==="(")this.consumeBudget(100),this.stack.push({parent:i.parent,root:!1});else if(a===")")this.stack.length>1&&this.stack.pop();else if(a==="{"){let c=s.lastIndex,l=r[c]===" "?c+1:c;r=r.slice(l),this.state=4;continue t}else this.consumeBudget(100),a.startsWith("O")||a.startsWith("0")||a.startsWith("o")?a=a.replace(/[0o]/g,"O").replace(/[–—]/g,"-"):(a==="Z0"||a==="0000"||a==="@@@@")&&(a="--"),i.node&&(i.parent=i.node),i.node=new $({san:a,startingComments:i.startingComments}),i.startingComments=void 0,i.root=!1,i.parent.children.push(i.node)}return}case 4:{let s=r.indexOf("}");if(s===-1){this.commentBuf.push(r);return}else{let n=s>0&&r[s-1]===" "?s-1:s;this.commentBuf.push(r.slice(0,n)),this.handleComment(),r=r.slice(s),this.state=3,t=!1}}}}handleHeader(t,r){this.game.headers.set(t,t==="Result"?$t(Ht(r)):r)}handleNag(t){var r;this.consumeBudget(50);let s=this.stack[this.stack.length-1];s.node&&((r=s.node.data).nags||(r.nags=[]),s.node.data.nags.push(t))}handleComment(){var t,r;this.consumeBudget(100);let s=this.stack[this.stack.length-1],n=this.commentBuf.join(`
`);this.commentBuf=[],s.node?((t=s.node.data).comments||(t.comments=[]),s.node.data.comments.push(n)):s.root?((r=this.game).comments||(r.comments=[]),this.game.comments.push(n)):(s.startingComments||(s.startingComments=[]),s.startingComments.push(n))}emit(t){if(this.state===4&&this.handleComment(),t)return this.emitGame(this.game,t);this.found&&this.emitGame(this.game,void 0),this.resetGame()}},Xe=(e,t=St)=>{let r=[];return new xt(s=>r.push(s),t,NaN).parse(e),r},ge=e=>{switch((e||"chess").toLowerCase()){case"chess":case"chess960":case"chess 960":case"standard":case"from position":case"classical":case"normal":case"fischerandom":case"fischerrandom":case"fischer random":case"wild/0":case"wild/1":case"wild/2":case"wild/3":case"wild/4":case"wild/5":case"wild/6":case"wild/7":case"wild/8":case"wild/8a":return"chess";case"crazyhouse":case"crazy house":case"house":case"zh":return"crazyhouse";case"king of the hill":case"koth":case"kingofthehill":return"kingofthehill";case"three-check":case"three check":case"threecheck":case"three check chess":case"3-check":case"3 check":case"3check":return"3check";case"antichess":case"anti chess":case"anti":return"antichess";case"atomic":case"atom":case"atomic chess":return"atomic";case"horde":case"horde chess":return"horde";case"racing kings":case"racingkings":case"racing":case"race":return"racingkings";default:return}},be=e=>{switch(e){case"chess":return;case"crazyhouse":return"Crazyhouse";case"racingkings":return"Racing Kings";case"horde":return"Horde";case"atomic":return"Atomic";case"antichess":return"Antichess";case"3check":return"Three-check";case"kingofthehill":return"King of the Hill"}},tr=e=>{let t=ge(e.get("Variant"));if(!t)return f.err(new m(k.Variant));let r=e.get("FEN");return r?ht(r).chain(s=>fe(t,s)):f.ok(Kt(t))},er=(e,t)=>{let r=be(t.rules);r?e.set("Variant",r):e.delete("Variant");let s=lt(t.toSetup()),n=lt(Kt(t.rules).toSetup());s!==n?e.set("FEN",s):e.delete("FEN")},rr=e=>"pawns"in e,xe=e=>"mate"in e,pe=e=>{e=Math.max(0,e);let t=Math.floor(e/3600),r=Math.floor(e%3600/60);return e=e%3600%60,`${t}:${r.toString().padStart(2,"0")}:${e.toLocaleString("en",{minimumIntegerDigits:2,maximumFractionDigits:3})}`},ke=e=>{switch(e){case"green":return"G";case"red":return"R";case"yellow":return"Y";case"blue":return"B"}};function sr(e){switch(e){case"G":return"green";case"R":return"red";case"Y":return"yellow";case"B":return"blue";default:return}}var me=e=>e.to===e.from?`${ke(e.color)}${y(e.to)}`:`${ke(e.color)}${y(e.from)}${y(e.to)}`,nr=e=>{let t=sr(e.slice(0,1)),r=q(e.slice(1,3)),s=q(e.slice(3,5));if(!(!t||!u(r))){if(e.length===3)return{color:t,from:r,to:r};if(e.length===5&&u(s))return{color:t,from:r,to:s}}},ir=e=>{let t=xe(e)?"#"+e.mate:e.pawns.toFixed(2);return u(e.depth)?t+","+e.depth:t},or=e=>{let t=[];u(e.text)&&t.push(e.text);let r=(e.shapes||[]).filter(n=>n.to===n.from).map(me);r.length&&t.push(`[%csl ${r.join(",")}]`);let s=(e.shapes||[]).filter(n=>n.to!==n.from).map(me);return s.length&&t.push(`[%cal ${s.join(",")}]`),e.evaluation&&t.push(`[%eval ${ir(e.evaluation)}]`),u(e.emt)&&t.push(`[%emt ${pe(e.emt)}]`),u(e.clock)&&t.push(`[%clk ${pe(e.clock)}]`),t.join(" ")},ar=e=>{let t,r,s,n=[];return{text:e.replace(/\s?\[%(emt|clk)\s(\d{1,5}):(\d{1,2}):(\d{1,2}(?:\.\d{0,3})?)\]\s?/g,(a,c,l,h,d)=>{let b=parseInt(l,10)*3600+parseInt(h,10)*60+parseFloat(d);return c==="emt"?t=b:c==="clk"&&(r=b),"  "}).replace(/\s?\[%(?:csl|cal)\s([RGYB][a-h][1-8](?:[a-h][1-8])?(?:,[RGYB][a-h][1-8](?:[a-h][1-8])?)*)\]\s?/g,(a,c)=>{for(let l of c.split(","))n.push(nr(l));return"  "}).replace(/\s?\[%eval\s(?:#([+-]?\d{1,5})|([+-]?(?:\d{1,5}|\d{0,5}\.\d{1,2})))(?:,(\d{1,5}))?\]\s?/g,(a,c,l,h)=>{let d=h&&parseInt(h,10);return s=c?{mate:parseInt(c,10),depth:d}:{pawns:parseFloat(l),depth:d},"  "}).trim(),shapes:n,emt:t,clock:r,evaluation:s}};var jt={};tt(jt,{chessgroundDests:()=>cr,chessgroundMove:()=>hr,lichessRules:()=>lr,lichessVariant:()=>fr,scalachessCharPair:()=>ur});var cr=(e,t)=>{let r=new Map,s=e.ctx();for(let[n,i]of e.allDests(s))if(i.nonEmpty()){let a=Array.from(i,y);!(t!=null&&t.chess960)&&n===s.king&&g(n)===4&&(i.has(0)?a.push("c1"):i.has(56)&&a.push("c8"),i.has(7)?a.push("g1"):i.has(63)&&a.push("g8")),r.set(y(n),a)}return r},hr=e=>A(e)?[y(e.to)]:[y(e.from),y(e.to)],ur=e=>A(e)?String.fromCharCode(35+e.to,139+["queen","rook","bishop","knight","pawn"].indexOf(e.role)):String.fromCharCode(35+e.from,e.promotion?99+8*["queen","rook","bishop","knight","king"].indexOf(e.promotion)+g(e.to):35+e.to),lr=e=>{switch(e){case"standard":case"chess960":case"fromPosition":return"chess";case"threeCheck":return"3check";case"kingOfTheHill":return"kingofthehill";case"racingKings":return"racingkings";default:return e}},fr=e=>{switch(e){case"chess":return"standard";case"3check":return"threeCheck";case"kingofthehill":return"kingOfTheHill";case"racingkings":return"racingKings";default:return e}};var dr=e=>ut(e),fs=e=>{let t=[];for(let r=7;r>=0;r--)for(let s=0;s<8;s++){let n=s+r*8,i=e.get(n),a=i?dr(i):".";t.push(a),t.push(s<7?a.length<2?" ":"":`
`)}return t.join("")};export{f as a,D as b,Z as c,C as d,R as e,A as f,Zt as g,p as h,v as i,g as j,et as k,P as l,I as m,q as n,y as o,Ce as p,Re as q,B as r,H as s,K as t,L as u,U as v,it as w,Pt as x,V as y,M as z,k as A,N as B,Q as C,Bt as D,te as E,G as F,T as G,Fe as H,cr as I,hr as J,ur as K,lr as L,jt as M,se as N,Ke as O,ie as P,Le as Q,ae as R,ht as S,ce as T,lt as U,Ft as V,fs as W,re as X,_e as Y,De as Z,zt as _,pt as $,Kt as aa,fe as ba,we as ca,je as da,Xe as ea,be as fa,tr as ga,ar as ha,Qt as ia};
